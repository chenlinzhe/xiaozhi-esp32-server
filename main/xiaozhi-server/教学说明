# ç”¨æˆ·è¾“å…¥åˆ° handle_chat_mode çš„å®Œæ•´è°ƒç”¨é“¾

## å®Œæ•´è°ƒç”¨é¡ºåº

### 1. ç”¨æˆ·éŸ³é¢‘è¾“å…¥
```
WebSocket æ¥æ”¶éŸ³é¢‘æ•°æ®
â†“
connection.py: handle_connection() 
  â†’ é€šè¿‡ WebSocket æ¥æ”¶éŸ³é¢‘å¸§
â†“
receiveAudioHandle.py: handleAudioMessage(conn, audio)
```

### 2. VAD æ£€æµ‹å’Œ ASR å¤„ç†
```
receiveAudioHandle.py: handleAudioMessage()
  â†’ æ£€æµ‹æ˜¯å¦æœ‰è¯­éŸ³ (VAD)
  â†’ è°ƒç”¨ conn.asr.receive_audio(conn, audio, have_voice)
â†“
asr/base.py: receive_audio()
  â†’ æ¥æ”¶éŸ³é¢‘ç‰‡æ®µï¼Œç´¯ç§¯åˆ° asr_audio åˆ—è¡¨
  â†’ å½“æ£€æµ‹åˆ°è¯­éŸ³åœæ­¢æ—¶ï¼Œè°ƒç”¨ handle_voice_stop()
â†“
asr/base.py: handle_voice_stop(conn, asr_audio_task)
  â†’ å¹¶è¡Œå¤„ç† ASR è¯†åˆ«å’Œå£°çº¹è¯†åˆ«
  â†’ ASR è¯†åˆ«å®Œæˆåå¾—åˆ°æ–‡æœ¬: raw_text
  â†’ å¦‚æœæ–‡æœ¬é•¿åº¦ > 2ï¼Œè°ƒç”¨ startToChat()
```

### 3. å¼€å§‹èŠå¤©å¤„ç†
```
receiveAudioHandle.py: startToChat(conn, text)
  â†’ æ£€æŸ¥è®¾å¤‡ç»‘å®šçŠ¶æ€
  â†’ æ£€æŸ¥è¾“å‡ºå­—æ•°é™åˆ¶
  â†’ å¤„ç†ä¸­æ–­é€»è¾‘
  â†“
  â†’ è°ƒç”¨ handle_user_intent(conn, actual_text)  // ğŸ”¥ æ„å›¾å¤„ç†å…¥å£
```

### 4. æ„å›¾å¤„ç†
```
intentHandler.py: handle_user_intent(conn, text)
  â†’ æ£€æŸ¥é€€å‡ºå‘½ä»¤
  â†’ æ£€æŸ¥å”¤é†’è¯
  â†’ æ£€æŸ¥åœºæ™¯è§¦å‘ (scenario_trigger)
  â†’ å¦‚æœæ­£åœ¨æ‰§è¡Œåœºæ™¯å¯¹è¯ï¼Œå¤„ç†åœºæ™¯é€»è¾‘
  â†’ å¦åˆ™è¿›è¡Œ LLM æ„å›¾åˆ†æ
  
  // å¦‚æœåœºæ™¯è§¦å‘æˆåŠŸï¼Œä¼šè°ƒç”¨ teaching_handler.handle_chat_mode()
  // ä½†åœ¨ intentHandler ä¸­çš„è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼š
  // handled = await conn.teaching_handler.handle_chat_mode(text)
  
  â†’ å¦‚æœæ„å›¾å·²è¢«å¤„ç† (è¿”å› True)ï¼Œç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­
  â†’ å¦‚æœæ„å›¾æœªè¢«å¤„ç† (è¿”å› False)ï¼Œç»§ç»­æ‰§è¡Œ
â†“
receiveAudioHandle.py: startToChat() ç»§ç»­
  â†’ è°ƒç”¨ send_stt_message(conn, actual_text)  // å‘é€è¯†åˆ«ç»“æœåˆ°å‰ç«¯
  â†’ è°ƒç”¨ conn.executor.submit(conn.chat, actual_text)  // ğŸ”¥ æäº¤åˆ°çº¿ç¨‹æ± æ‰§è¡Œ chat()
```

### 5. èŠå¤©å¤„ç† - handle_chat_mode çš„è°ƒç”¨æ—¶æœº
```
connection.py: chat(query, tool_call=False, depth=0)
  
  // ğŸ”¥ å…³é”®ï¼šåœ¨æœ€é¡¶å±‚è°ƒç”¨æ—¶ï¼ˆdepth == 0ï¼‰ï¼Œé¦–å…ˆæ£€æŸ¥èŠå¤©æ¨¡å¼
  if depth == 0:
      chat_result = self._handle_chat_mode(query)  // ğŸ”¥ è¿™é‡Œè°ƒç”¨
      if chat_result:
          return chat_result  // å¦‚æœè¿”å› Trueï¼Œç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­ LLM å¤„ç†
  
  // å¦‚æœ handle_chat_mode è¿”å› None æˆ– Falseï¼Œç»§ç»­æ‰§è¡Œï¼š
  â†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
  â†’ è°ƒç”¨ LLM ç”Ÿæˆå›å¤
  â†’ å¤„ç†æµå¼å“åº”
  â†’ å‘é€ TTS æ¶ˆæ¯
```

### 6. handle_chat_mode å†…éƒ¨å¤„ç†
```
connection.py: _handle_chat_mode(query)
  â†’ è°ƒç”¨ self.teaching_handler.handle_chat_mode(query)
â†“
teaching_handler.py: handle_chat_mode(query)
  
  1. è·å–ç”¨æˆ·ID (device_id æˆ– session_id)
  2. æ£€æŸ¥å½“å‰èŠå¤©çŠ¶æ€ (ä» Redis)
  3. å¼‚æ­¥è°ƒç”¨ chat_status_manager.handle_user_input()
     â†’ future = asyncio.run_coroutine_threadsafe(...)
     â†’ result = future.result()  // ç­‰å¾…å¼‚æ­¥ç»“æœ
  4. æ ¹æ®è¿”å›çš„ action å¤„ç†ï¼š
     
     - "mode_switch": æ¨¡å¼åˆ‡æ¢
     - "start_teaching": å¼€å§‹æ•™å­¦
     - "next_step" / "perfect_match_next" / "partial_match_next" / "no_match_next": æ•™å­¦æ­¥éª¤å¤„ç†
     - "retry" / "retry_current_step": é‡è¯•å½“å‰æ­¥éª¤
     - "completed": æ•™å­¦å®Œæˆ
     
  5. è¿”å› True (å·²å¤„ç†) æˆ– None (ç»§ç»­æ­£å¸¸æµç¨‹)
```

## å…³é”®æ—¶é—´ç‚¹

### handle_chat_mode ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Ÿ

1. **ä¸»è¦è°ƒç”¨è·¯å¾„**ï¼š
   - ç”¨æˆ·è¾“å…¥æ–‡æœ¬ â†’ `startToChat()` â†’ `handle_user_intent()` â†’ `conn.chat()` â†’ `_handle_chat_mode()` â†’ `handle_chat_mode()`

2. **è°ƒç”¨æ—¶æœº**ï¼š
   - **æ¯æ¬¡ç”¨æˆ·è¾“å…¥æ—¶**ï¼Œåœ¨ `chat()` æ–¹æ³•çš„æœ€å¼€å§‹ï¼ˆdepth == 0 æ—¶ï¼‰è°ƒç”¨
   - **åœ¨ LLM å¤„ç†ä¹‹å‰**ï¼Œå¦‚æœ `handle_chat_mode` è¿”å› Trueï¼Œå°±ä¸ä¼šè°ƒç”¨ LLM

3. **å¼‚æ­¥å¤„ç†**ï¼š
   - `handle_chat_mode` å†…éƒ¨ä½¿ç”¨ `asyncio.run_coroutine_threadsafe()` è°ƒç”¨ `chat_status_manager.handle_user_input()`
   - è¿™æ˜¯ä¸€ä¸ª**åŒæ­¥é˜»å¡**è°ƒç”¨ï¼Œä¼šç­‰å¾…å¼‚æ­¥ç»“æœå®Œæˆ

4. **è¿”å›å€¼å½±å“**ï¼š
   - è¿”å› `True`: è¡¨ç¤ºå·²å¤„ç†ï¼Œ`chat()` æ–¹æ³•ç›´æ¥è¿”å›ï¼Œä¸è°ƒç”¨ LLM
   - è¿”å› `None`: è¡¨ç¤ºç»§ç»­æ­£å¸¸æµç¨‹ï¼Œ`chat()` æ–¹æ³•ç»§ç»­æ‰§è¡Œ LLM å¤„ç†

## å¾ªç¯æ—¶çš„è°ƒç”¨æµç¨‹ï¼ˆå®Œå…¨åŒ¹é…åï¼‰

å½“ç”¨æˆ·è¾“å…¥"æ¸´æ°´"å®Œå…¨åŒ¹é…åï¼š

1. **å½“å‰è¾“å…¥**ï¼šç”¨æˆ·è¯´"æ¸´æ°´"
   - `startToChat("æ¸´æ°´")` 
   - `handle_user_intent("æ¸´æ°´")` â†’ è¿”å› False (æœªå¤„ç†)
   - `conn.chat("æ¸´æ°´")` 
   - `_handle_chat_mode("æ¸´æ°´")`
   - `handle_chat_mode("æ¸´æ°´")`
     - è°ƒç”¨ `chat_status_manager.handle_user_input()`
     - è¯„ä¼°ä¸ºå®Œå…¨åŒ¹é…ï¼Œè¿”å› `action="perfect_match_next"`, `current_step=ä¸‹ä¸€æ­¥éª¤`
   - `handle_chat_mode` å¤„ç† `perfect_match_next`ï¼š
     - è·å–ä¸‹ä¸€æ­¥éª¤çš„ `step_id`
     - å¦‚æœæœ‰æ¶ˆæ¯åˆ—è¡¨ï¼Œå‘é€æ¶ˆæ¯åˆ—è¡¨
     - å¦‚æœæ²¡æœ‰æ¶ˆæ¯åˆ—è¡¨ï¼Œå‘é€è¯„ä¼°åé¦ˆæˆ–é»˜è®¤æç¤º
   - è¿”å› `True`ï¼Œ`chat()` æ–¹æ³•è¿”å›ï¼Œ**ä¸è°ƒç”¨ LLM**

2. **ä¸‹ä¸€æ¬¡å¾ªç¯**ï¼šç”¨æˆ·å†è¯´"æ¸´æ°´"ï¼ˆç¬¬äºŒæ¬¡ï¼‰
   - åŒæ ·çš„æµç¨‹
   - å¦‚æœè¿™æ¬¡ä¹Ÿæ˜¯å®Œå…¨åŒ¹é…ï¼Œç»§ç»­å¾ªç¯
   - å¦‚æœè¿™æ¬¡ä¸å®Œå…¨åŒ¹é…ï¼Œè¿›å…¥ `partial_match_next` æˆ– `no_match_next` åˆ†æ”¯

## é—®é¢˜å®šä½

ç”¨æˆ·è¯´"é€»è¾‘å¹¶æ²¡æœ‰èµ°åˆ°'æ²¡æœ‰æ­¥éª¤æ¶ˆæ¯ï¼Œæ£€æŸ¥è¯„ä¼°åé¦ˆ'"ï¼Œå¯èƒ½çš„åŸå› ï¼š

1. **æœ‰æ¶ˆæ¯åˆ—è¡¨**ï¼šä¸‹ä¸€æ­¥éª¤æœ‰æ¶ˆæ¯åˆ—è¡¨ï¼Œ`message_sent = True`ï¼Œæ‰€ä»¥ä¸ä¼šèµ°åˆ° `if not message_sent` åˆ†æ”¯

2. **æå‰è¿”å›**ï¼šåœ¨æŸä¸ªåœ°æ–¹æå‰è¿”å›äº†ï¼Œæ²¡æœ‰æ‰§è¡Œåˆ°æ£€æŸ¥è¯„ä¼°åé¦ˆçš„ä»£ç 

3. **å¼‚å¸¸ä¸­æ–­**ï¼šåœ¨ `_send_message_list` æˆ–å…¶ä»–åœ°æ–¹æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´åç»­ä»£ç æœªæ‰§è¡Œ

éœ€è¦æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ï¼š
- `step_id` æ˜¯å¦æœ‰å€¼
- `message_list` æ˜¯å¦ä¸ºç©º
- `message_sent` çš„æœ€ç»ˆå€¼
- æ˜¯å¦æœ‰å¼‚å¸¸æ—¥å¿—
