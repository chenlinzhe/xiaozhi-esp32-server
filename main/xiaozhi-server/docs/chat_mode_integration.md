# 聊天模式集成使用说明

## 概述

本系统已经集成了聊天模式切换和教学模式功能，支持用户在自由聊天和教学模式之间切换。

## 功能特性

### 1. 聊天模式切换
- **切换到教学模式**: 用户说"切换到教学模式"、"教学模式"或"开始教学"
- **切换到自由模式**: 用户说"切换到自由模式"、"自由模式"或"自由聊天"

### 2. 教学模式流程
1. 用户切换到教学模式后，系统自动选择默认教学场景
2. 系统输出场景中的第一句话
3. 等待5-10秒用户回复
4. 如果用户没有回复，系统自动回复场景中配置的答案
5. 如果用户回复了，判断是否正确：
   - 正确：夸奖用户，切换到自由聊天
   - 不正确：再教一遍

### 3. 自由模式
- 正常的AI对话模式
- 支持所有原有的聊天功能

## 技术实现

### 核心组件

1. **ChatStatusManager** (`core/scenario/chat_status_manager.py`)
   - 管理聊天状态切换
   - 处理教学模式逻辑
   - 管理超时检查

2. **DialogueService** (`core/scenario/dialogue_service.py`)
   - 场景对话服务
   - 获取场景配置
   - 处理教学步骤

3. **Redis客户端** (`core/utils/redis_client.py`)
   - 存储聊天状态（30分钟过期）
   - 存储会话数据

### 数据存储

- **聊天状态**: `setting:chat_status:{user_id}` (30分钟过期)
- **教学会话**: `session:teaching_{user_id}` (30分钟过期)

## 使用方法

### 1. 启动服务
确保Redis服务正在运行，然后启动xiaozhi-server：

```bash
cd main/xiaozhi-server
python app.py
```

### 2. 测试功能
运行测试脚本验证功能：

```bash
python test_chat_mode_integration.py
```

### 3. 用户交互示例

```
用户: "切换到教学模式"
AI: "好的，小朋友！现在进入教学模式。让我为你选择一个学习场景。"

用户: "你好"
AI: [根据场景配置回复]

用户: "切换到自由模式"
AI: "好的，小朋友！现在进入自由聊天模式，我们可以随意聊天了。"
```

## 配置说明

### Redis配置
在 `config.yaml` 中配置Redis连接：

```yaml
redis:
  host: localhost
  port: 6379
  password: null
  db: 0
```

### 场景配置
场景配置通过管理后台进行，包括：
- 场景基本信息
- 教学步骤配置
- 期望答案配置
- 超时时间配置

## 故障排除

### 1. Redis连接失败
- 检查Redis服务是否启动
- 检查Redis配置是否正确
- 查看日志中的错误信息

### 2. 场景获取失败
- 检查管理API服务是否正常运行
- 确认场景配置是否正确
- 查看网络连接是否正常

### 3. 模式切换不生效
- 检查用户ID是否正确
- 确认Redis存储是否成功
- 查看聊天状态管理器的日志

## 扩展功能

### 1. 自定义关键词
可以在 `ChatStatusManager` 中修改关键词配置：

```python
self.TEACHING_MODE_KEYWORDS = ["切换到教学模式", "教学模式", "开始教学"]
self.FREE_MODE_KEYWORDS = ["切换到自由模式", "自由模式", "自由聊天"]
```

### 2. 自定义等待时间
修改等待时间配置：

```python
self.WAIT_TIME_MIN = 5  # 最小等待时间（秒）
self.WAIT_TIME_MAX = 10  # 最大等待时间（秒）
```

### 3. 添加新的聊天模式
1. 在 `ChatStatusManager` 中添加新的模式处理逻辑
2. 在 `ConnectionHandler` 中添加对应的处理分支
3. 更新Redis存储逻辑

## 注意事项

1. **Redis依赖**: 确保Redis服务正常运行
2. **用户ID**: 使用设备ID作为用户唯一标识
3. **超时处理**: 教学模式的超时检查在后台线程中执行
4. **资源清理**: 连接关闭时会自动清理相关的会话数据
5. **错误处理**: 所有异常都有相应的错误处理和日志记录

## 日志监控

关键日志信息：
- 聊天模式切换
- 教学会话开始/结束
- 超时检查触发
- 错误异常信息

可以通过日志级别调整来获取更详细的调试信息。
