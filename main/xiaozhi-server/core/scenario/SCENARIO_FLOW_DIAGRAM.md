# Scenario 文件夹流程图

## 1. 整体架构流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    小智ESP32服务器场景教学系统                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    主连接处理器 (ConnectionHandler)                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    teaching_handler.py                          │
│                   教学处理器 (入口层)                            │
│              - 模式切换检测 - TTS消息发送 - 超时管理              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    chat_status_manager.py                       │
│                   聊天状态管理器 (核心协调层)                     │
│              - 状态管理 - 用户输入处理 - 评估逻辑                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     dialogue_service.py                         │
│                   场景对话服务 (业务逻辑层)                       │
│              - 场景启动 - 步骤管理 - 响应评估                     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              scenario_manager.py + step_manager.py              │
│                   场景管理器 (数据管理层)                        │
│              - 场景CRUD - 步骤CRUD - 数据查询                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    config.manage_api_client                     │
│                        API调用层                                │
│              - HTTP请求 - 数据转换 - 错误处理                    │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 详细调用关系流程图

```
用户输入 (语音/文本)
    │
    ▼
┌─────────────────┐
│  teaching_handler │
│   (教学处理器)    │
│ - 模式切换检测    │
│ - TTS消息发送     │
│ - 超时检查管理    │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│chat_status_manager│
│  (聊天状态管理)   │
│ - 状态判断       │
│ - 用户输入处理    │
│ - 评估逻辑       │
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│dialogue_service│  │Redis存储   │
│ (场景对话服务) │  │(会话状态)   │
│ - 场景启动     │  │- 用户状态   │
│ - 步骤管理     │  │- 会话数据   │
│ - 响应评估     │  │- 超时状态   │
└─────────────┘  └─────────────┘
    │
    ▼
┌─────────────────┐
│scenario_manager │
│   (场景管理)     │
│ - 场景CRUD      │
│ - 步骤CRUD      │
│ - 数据查询      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│manage_api_client│
│   (API调用)      │
│ - HTTP请求      │
│ - 数据转换      │
│ - 错误处理      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   外部API服务    │
│ (场景/步骤数据)  │
└─────────────────┘
```

## 3. 教学流程详细图

```
开始教学
    │
    ▼
┌─────────────────┐
│ 检测模式切换命令  │
│ (教学模式/自由模式)│
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 切换到教学模式   │
│ 设置用户状态     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 获取默认场景     │
│ (isDefaultTeaching)│
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 开始场景对话     │
│ 创建会话数据     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 检查消息列表配置  │
│ (stepId消息列表) │
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 有消息列表   │  │ 无消息列表   │
│ 发送多条消息  │  │ 发送单条消息  │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 启动渐进式超时   │ │ 启动渐进式超时   │
│ 检查(延迟2秒)   │ │ 检查(延迟2秒)   │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 等待用户回复     │ │ 等待用户回复     │
│ (40%警告/70%最终)│ │ (40%警告/70%最终)│
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 智能评估用户回复   │ │  智能评估用户回复  │
│ (完全/部分/关键词) │ │ (完全/部分/关键词)│
│ 📍 _evaluate_   │ │ 📍 _evaluate_  │
│ response_with_  │ │ response_with_  │
│ config()        │ │ config()        │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 根据分数分支跳转   │ │ 根据分数分支跳转   │
│ (≥90/≥60/<60)   │ │ (≥90/≥60/<60)   │
│ 📍 _process_    │ │ 📍 _process_    │
│ teaching_       │ │ teaching_       │
│ response()      │ │ response()      │
│ 第617-635行     │ │ 第617-635行     │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 检查回复次数限制  │ │ 检查回复次数限制  │
│ (默认3次)       │ │ (默认3次)       │
└─────────────────┘ └─────────────────┘
    │                 │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 未超限制     │  │ 超过限制     │
│ 进入下一步   │  │ 教学结束     │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 计算最终得分     │ │ 计算最终得分     │
│ 切换到自由模式   │ │ 切换到自由模式   │
└─────────────────┘ └─────────────────┘
```

## 4. 智能评估与分支跳转逻辑图

```
用户回复
    │
    ▼
┌─────────────────┐
│ 智能评估系统     │
│ (基于步骤配置)   │
│ 📍 chat_status_manager.py │
│ _process_teaching_response() │
│ 第554-559行     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 解析评估配置     │
│ - successCondition│
│ - expectedKeywords│
│ - expectedPhrases│
│ 📍 _evaluate_response_with_config() │
│ 第815-948行     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 计算评估分数     │
│ 📍 _evaluate_response_with_config() │
│ 第864-932行     │
│ - exact模式: 100分或0分 │
│ - partial模式: 80分或70分 │
│ - keyword模式: 60分或0分 │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 根据分数判断分支  │
│ 📍 _process_teaching_response() │
│ 第617-635行     │
└─────────────────┘
    │
    ├─────────────────┬─────────────────┬─────────────────┐
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 完全匹配     │ │ 部分匹配     │ │ 关键词匹配   │ │ 完全不匹配   │
│ (≥90分)      │ │ (60-89分)    │ │ (40-59分)    │ │ (<40分)      │
│ exact模式    │ │ partial模式  │ │ keyword模式  │ │ 默认模式     │
│ 📍 第621-625行│ │ 📍 第626-630行│ │ 📍 第631-635行│ │ 📍 第631-635行│
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│perfectMatchNext│ │partialMatchNext│ │keywordMatchNext│ │noMatchNextStep│
│StepId跳转    │ │StepId跳转    │ │StepId跳转    │ │Id跳转        │
│ 📍 第623行   │ │ 📍 第628行   │ │ 📍 第633行   │ │ 📍 第633行   │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 查找指定步骤 │ │ 查找指定步骤 │ │ 查找指定步骤 │ │ 查找指定步骤 │
│ 或进入下一步 │ │ 或进入下一步 │ │ 或进入下一步 │ │ 或进入下一步 │
│ 📍 _find_step_by_id() │ │ 📍 _find_step_by_id() │ │ 📍 _find_step_by_id() │ │ 📍 _find_step_by_id() │
│ 第1323-1355行│ │ 第1323-1355行│ │ 第1323-1355行│ │ 第1323-1355行│
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 更新会话状态 │ │ 更新会话状态 │ │ 更新会话状态 │ │ 更新会话状态 │
│ 重置重试次数 │ │ 重置重试次数 │ │ 重置重试次数 │ │ 重置重试次数 │
│ 📍 第637-638行│ │ 📍 第637-638行│ │ 📍 第637-638行│ │ 📍 第637-638行│
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

## 5. 消息列表处理流程图

```
步骤配置检查
    │
    ▼
┌─────────────────┐
│ 获取步骤ID      │
│ (stepId字段)    │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 调用API获取     │
│ 消息列表        │
│ (get_step_messages)│
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 有消息列表   │  │ 无消息列表   │
│ (长度>0)    │  │ (长度=0)    │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 遍历消息列表     │ │ 使用单条AI消息   │
│ 处理每条消息     │ │ (aiMessage字段) │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 替换儿童姓名     │ │ 替换儿童姓名     │
│ ({childName})   │ │ ({childName})   │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 获取语速配置     │ │ 使用默认语速     │
│ (speechRate)    │ │ (1.0倍速)      │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 获取等待时间     │ │ 无等待时间      │
│ (waitTimeSeconds)│ │ (0秒)          │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 独立TTS会话发送  │ │ 标准TTS会话发送  │
│ (每条消息独立)   │ │ (单条消息)      │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 添加到对话历史   │ │ 添加到对话历史   │
│ (Message对象)   │ │ (Message对象)   │
└─────────────────┘ └─────────────────┘
```

## 6. 渐进式超时检查流程图

```
TTS消息发送完成
    │
    ▼
┌─────────────────┐
│ 延迟2秒启动     │
│ 超时检查        │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 更新等待开始时间 │
│ (wait_start_time)│
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 获取步骤超时配置 │
│ (timeoutSeconds)│
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 计算警告时间点   │
│ (40% * timeout) │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 等待到警告时间点 │
│ 检查是否已发送   │
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 未发送警告   │  │ 已发送警告   │
│ 发送警告提示  │  │ 跳过警告     │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 计算最终提醒时间点│ │ 计算最终提醒时间点│
│ (70% * timeout) │ │ (70% * timeout) │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 等待到最终提醒   │ │ 等待到最终提醒   │
│ 检查是否已发送   │ │ 检查是否已发送   │
└─────────────────┘ └─────────────────┘
    │                 │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 未发送最终提醒│ │ 已发送最终提醒│
│ 发送最终提醒  │ │ 跳过最终提醒  │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 等待到超时时间   │ │ 等待到超时时间   │
│ (100% * timeout)│ │ (100% * timeout)│
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 发送超时回复     │ │ 发送超时回复     │
│ 使用autoReplyOnTimeout│ │ 使用autoReplyOnTimeout│
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 根据分支配置     │ │ 根据分支配置     │
│ 进入下一步       │ │ 进入下一步       │
└─────────────────┘ └─────────────────┘
```

## 6. 数据流向图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户输入       │───▶│  teaching_handler│───▶│chat_status_manager│
│  (语音/文本)     │    │   (教学处理器)   │    │  (状态管理器)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Redis存储      │◀───│dialogue_service │◀───│   状态管理       │
│  (会话状态)      │    │  (对话服务)      │    │  (会话数据)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API调用        │◀───│scenario_manager │◀───│   场景管理       │
│ (场景/步骤数据)  │    │  (场景管理器)    │    │  (场景配置)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据库存储     │◀───│learning_record  │◀───│   学习记录       │
│  (学习记录)      │    │  (记录管理器)    │    │  (统计数据)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 7. 文件依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        scenario/ 文件夹                         │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│teaching_handler│      │chat_status_ │        │dialogue_    │
│.py           │        │manager.py   │        │service.py   │
│(教学处理器)   │        │(状态管理)   │        │(对话服务)   │
└─────────────┘        └─────────────┘        └─────────────┘
        │                       │                       │
        │                       ▼                       ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │Redis Client │        │scenario_    │
        │               │(状态存储)    │        │manager.py   │
        │               └─────────────┘        └─────────────┘
        │                                               │
        │                                               ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │learning_    │        │dialogue_    │
        │               │record_      │        │executor.py  │
        │               │manager.py   │        │(执行器)     │
        │               └─────────────┘        └─────────────┘
        │                       │                       │
        │                       ▼                       ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │数据库存储    │        │scenario_    │
        │               │(学习记录)    │        │dialogue_    │
        │               └─────────────┘        │service.py   │
        │                                      │(场景对话)   │
        │                                      └─────────────┘
        │                                               │
        │                                               ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │config.      │        │外部API服务   │
        │               │manage_api_  │        │(场景数据)    │
        │               │client       │        │(步骤数据)    │
        │               │(API调用)     │        └─────────────┘
        │               └─────────────┘
        │
        ▼
┌─────────────┐
│TTS语音合成   │
│(音频输出)    │
│- 消息列表    │
│- 语速控制    │
│- 等待时间    │
└─────────────┘
```

## 8. 关键配置参数

```
┌─────────────────────────────────────────────────────────────────┐
│                        配置参数说明                              │
└─────────────────────────────────────────────────────────────────┘

超时配置 (PROGRESSIVE_TIMEOUT_CONFIG):
├── 基础超时时间: 40秒 (从步骤配置获取)
├── 最小超时时间: 20秒  
├── 最大超时时间: 120秒
├── 警告时间点: 40% (16秒)
├── 最终提醒时间点: 70% (28秒)
└── 延迟启动时间: 2秒 (等待TTS完成)

评估配置 (ASSESSMENT_CONFIG):
├── 最大重试次数: 3次 (从步骤配置获取)
├── 及格分数线: 60分
├── 良好分数线: 80分
├── 优秀分数线: 90分
└── 回复次数限制: 3次 (从场景配置获取)

匹配模式 (successCondition):
├── exact: 用户输入与期望短语完全一致 (≥90分)
├── partial: 用户输入包含期望短语或关键词 (60-89分)
├── keyword: 用户输入包含期望关键词 (40-59分)
└── 默认: 关键词匹配模式 (<40分)

分支跳转配置:
├── perfectMatchNextStepId: 完全匹配跳转步骤ID
├── partialMatchNextStepId: 部分匹配跳转步骤ID
├── keywordMatchNextStepId: 关键词匹配跳转步骤ID
└── noMatchNextStepId: 完全不匹配跳转步骤ID

消息列表配置:
├── messageContent: 消息内容
├── speechRate: 语速 (0.2-3.0倍速)
├── waitTimeSeconds: 等待时间 (秒)
└── messageType: 消息类型 (normal)

TTS配置:
├── 重试次数: 3次
├── 音频确认超时: 5秒
├── 语速范围: 0.2-3.0倍速
└── 独立会话: 每条消息独立TTS会话
```

## 9. 关键代码位置说明

```
┌─────────────────────────────────────────────────────────────────┐
│                    关键功能代码位置标注                          │
└─────────────────────────────────────────────────────────────────┘

用户输入得分判断:
├── 文件: chat_status_manager.py
├── 函数: _evaluate_response_with_config()
├── 位置: 第815-948行
├── 功能: 根据步骤配置评估用户回复并计算分数
└── 评分规则:
    ├── exact模式: 完全匹配100分，否则0分
    ├── partial模式: 短语匹配80分，关键词匹配70分，否则0分
    └── keyword模式: 关键词匹配60分，否则0分

三个分支跳转判断:
├── 文件: chat_status_manager.py
├── 函数: _process_teaching_response()
├── 位置: 第617-635行
├── 分支逻辑:
    ├── score >= 90: 完全匹配分支 (第621-625行)
    │   └── 跳转: perfectMatchNextStepId 或 exactMatchStepId
    ├── score >= 60: 部分匹配分支 (第626-630行)
    │   └── 跳转: partialMatchNextStepId 或 partialMatchStepId
    └── score < 60: 完全不匹配分支 (第631-635行)
        └── 跳转: noMatchNextStepId 或 noMatchStepId

步骤查找逻辑:
├── 文件: chat_status_manager.py
├── 函数: _find_step_by_id()
├── 位置: 第1323-1355行
├── 功能: 根据步骤ID查找对应的步骤索引
└── 匹配字段: stepId, id, stepCode

会话状态更新:
├── 文件: chat_status_manager.py
├── 函数: _process_teaching_response()
├── 位置: 第637-638行
├── 功能: 重置重试次数，更新会话状态
└── 操作: session_data["retry_count"] = 0

消息列表处理:
├── 文件: teaching_handler.py
├── 函数: _get_step_message_list()
├── 位置: 第472-495行
├── 功能: 获取步骤的消息列表配置
└── API调用: get_step_messages(step_id)

渐进式超时检查:
├── 文件: chat_status_manager.py
├── 函数: check_teaching_timeout()
├── 位置: 第1077-1321行
├── 功能: 检查教学会话超时并发送渐进式提示
└── 时间点: 40%警告, 70%最终提醒, 100%超时
```

## 10. 分支跳转问题诊断流程图

```
用户回复后没有走到三个分支
    │
    ▼
┌─────────────────┐
│ 检查评估分数     │
│ 📍 第614行      │
│ 日志: "评估分数: {score}" │
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 分数正常     │  │ 分数异常     │
│ (0-100)     │  │ (非预期值)   │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 检查分支配置     │ │ 检查评估逻辑     │
│ 📍 第623/628/633行│ │ 📍 _evaluate_   │
│ 日志: "跳转步骤ID"│ │ response_with_  │
└─────────────────┘ │ config()        │
    │               └─────────────────┘
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 配置存在     │  │ 配置缺失     │
│ (next_step_id)│ │ (next_step_id=None)│
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 检查步骤查找     │ │ 检查数据库配置   │
│ 📍 _find_step_  │ │ 📍 步骤配置表    │
│ by_id()         │ │ - perfectMatchNextStepId │
│ 第1323-1355行   │ │ - partialMatchNextStepId │
└─────────────────┘ │ - noMatchNextStepId │
    │               └─────────────────┘
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 查找成功     │  │ 查找失败     │
│ (next_step_index)│ │ (next_step_index=None)│
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 检查回复次数     │ │ 检查步骤ID格式   │
│ 📍 第576行      │ │ 📍 步骤列表      │
│ 日志: "用户回复次数统计"│ │ - stepId字段    │
└─────────────────┘ │ - id字段        │
    │               │ - stepCode字段   │
    ├─────────────────┐               └─────────────────┘
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 未超限制     │  │ 超过限制     │
│ (继续分支)   │  │ (提前结束)   │
└─────────────┘  └─────────────┘
    │
    ▼
┌─────────────────┐
│ 执行分支跳转     │
│ 📍 第641-792行  │
│ 日志: "根据{branch_type}分支配置" │
└─────────────────┘
```

## 11. 错误处理流程

```
异常发生
    │
    ▼
┌─────────────────┐
│ 捕获异常         │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 记录错误日志     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 判断错误类型     │
└─────────────────┘
    │
    ├─────────────────┬─────────────────┬─────────────────┐
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 网络错误     │ │ 配置错误     │ │ 数据错误     │ │ 系统错误     │
│ 重试机制     │ │ 使用默认值   │ │ 数据验证     │ │ 降级处理     │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 重试3次后失败   │ │ 继续执行        │ │ 返回错误信息    │ │ 切换到备用模式   │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 10. 性能优化点

```
┌─────────────────────────────────────────────────────────────────┐
│                        性能优化策略                              │
└─────────────────────────────────────────────────────────────────┘

1. 缓存策略:
   ├── Redis缓存会话状态
   ├── 内存缓存场景配置
   └── 本地缓存API响应

2. 异步处理:
   ├── 异步API调用
   ├── 异步超时检查
   └── 异步日志记录

3. 连接池:
   ├── HTTP连接池
   ├── Redis连接池
   └── 数据库连接池

4. 批量操作:
   ├── 批量保存学习记录
   ├── 批量更新状态
   └── 批量日志写入
```
