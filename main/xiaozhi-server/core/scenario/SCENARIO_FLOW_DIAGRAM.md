# Scenario 文件夹流程图

## 1. 整体架构流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    小智ESP32服务器场景教学系统                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    主连接处理器 (ConnectionHandler)                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│               teaching_handler.py / teaching_handler_improved.py │
│                        教学处理器 (入口层)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    chat_status_manager.py                       │
│                   聊天状态管理器 (核心协调层)                     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     dialogue_service.py                         │
│                   场景对话服务 (业务逻辑层)                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              scenario_manager.py + step_manager.py              │
│                   场景管理器 (数据管理层)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    config.manage_api_client                     │
│                        API调用层                                │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 详细调用关系流程图

```
用户输入
    │
    ▼
┌─────────────────┐
│  teaching_handler │
│   (教学处理器)    │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│chat_status_manager│
│  (聊天状态管理)   │
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│dialogue_service│  │Redis存储   │
│ (场景对话服务) │  │(状态管理)   │
└─────────────┘  └─────────────┘
    │
    ▼
┌─────────────────┐
│scenario_manager │
│   (场景管理)     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│manage_api_client│
│   (API调用)      │
└─────────────────┘
```

## 3. 教学流程详细图

```
开始教学
    │
    ▼
┌─────────────────┐
│ 检测模式切换命令  │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 切换到教学模式   │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 获取默认场景     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 开始场景对话     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 发送第一个步骤   │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 启动超时检查     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 等待用户回复     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 评估用户回复     │
└─────────────────┘
    │
    ├─────────────────┐
    ▼                 ▼
┌─────────────┐  ┌─────────────┐
│ 评估通过     │  │ 评估不通过   │
│ 进入下一步   │  │ 重试当前步骤 │
└─────────────┘  └─────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 检查是否完成     │ │ 检查重试次数     │
└─────────────────┘ └─────────────────┘
    │                 │
    ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ 教学完成         │ │ 继续重试/跳过    │
└─────────────────┘ └─────────────────┘
```

## 4. 三分支评估逻辑图

```
用户回复
    │
    ▼
┌─────────────────┐
│ 智能评估系统     │
└─────────────────┘
    │
    ├─────────────────┬─────────────────┬─────────────────┐
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 完全匹配     │ │ 部分匹配     │ │ 关键词匹配   │ │ 完全不匹配   │
│ (≥90分)      │ │ (60-89分)    │ │ (40-59分)    │ │ (<40分)      │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 跳转指定步骤 │ │ 跳转指定步骤 │ │ 跳转指定步骤 │ │ 重试当前步骤 │
│ 或进入下一步 │ │ 或进入下一步 │ │ 或进入下一步 │ │ 或使用替代消息│
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

## 5. 渐进式超时检查流程图

```
开始等待用户回复
    │
    ▼
┌─────────────────┐
│ 启动超时检查     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 等待70%时间     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 发送警告提示     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 等待90%时间     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 发送最终提醒     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 等待100%时间    │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 发送超时回复     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 进入下一步/完成  │
└─────────────────┘
```

## 6. 数据流向图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户输入       │───▶│  teaching_handler│───▶│chat_status_manager│
│  (语音/文本)     │    │   (教学处理器)   │    │  (状态管理器)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Redis存储      │◀───│dialogue_service │◀───│   状态管理       │
│  (会话状态)      │    │  (对话服务)      │    │  (会话数据)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API调用        │◀───│scenario_manager │◀───│   场景管理       │
│ (场景/步骤数据)  │    │  (场景管理器)    │    │  (场景配置)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据库存储     │◀───│learning_record  │◀───│   学习记录       │
│  (学习记录)      │    │  (记录管理器)    │    │  (统计数据)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 7. 文件依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        scenario/ 文件夹                         │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│teaching_handler│      │chat_status_ │        │dialogue_    │
│.py           │        │manager.py   │        │service.py   │
└─────────────┘        └─────────────┘        └─────────────┘
        │                       │                       │
        │                       ▼                       ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │Redis Client │        │scenario_    │
        │               │(状态存储)    │        │manager.py   │
        │               └─────────────┘        └─────────────┘
        │                                               │
        │                                               ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │learning_    │        │manage_api_  │
        │               │record_      │        │client       │
        │               │manager.py   │        │(API调用)     │
        │               └─────────────┘        └─────────────┘
        │                       │                       │
        │                       ▼                       ▼
        │               ┌─────────────┐        ┌─────────────┐
        │               │数据库存储    │        │外部API服务   │
        │               │(学习记录)    │        │(场景数据)    │
        │               └─────────────┘        └─────────────┘
        │
        ▼
┌─────────────┐
│TTS语音合成   │
│(音频输出)    │
└─────────────┘
```

## 8. 关键配置参数

```
┌─────────────────────────────────────────────────────────────────┐
│                        配置参数说明                              │
└─────────────────────────────────────────────────────────────────┘

超时配置:
├── 基础超时时间: 40秒
├── 最小超时时间: 20秒  
├── 最大超时时间: 120秒
├── 警告时间点: 70% (28秒)
└── 最终提醒时间点: 90% (36秒)

评估配置:
├── 最大重试次数: 3次
├── 及格分数线: 60分
├── 良好分数线: 80分
└── 优秀分数线: 90分

匹配模式:
├── 完全匹配: 用户输入与期望短语完全一致
├── 部分匹配: 用户输入包含期望短语或关键词
├── 关键词匹配: 用户输入包含期望关键词
└── 语义相似度: 基于同义词的模糊匹配
```

## 9. 错误处理流程

```
异常发生
    │
    ▼
┌─────────────────┐
│ 捕获异常         │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 记录错误日志     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 判断错误类型     │
└─────────────────┘
    │
    ├─────────────────┬─────────────────┬─────────────────┐
    ▼                 ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 网络错误     │ │ 配置错误     │ │ 数据错误     │ │ 系统错误     │
│ 重试机制     │ │ 使用默认值   │ │ 数据验证     │ │ 降级处理     │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 重试3次后失败   │ │ 继续执行        │ │ 返回错误信息    │ │ 切换到备用模式   │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 10. 性能优化点

```
┌─────────────────────────────────────────────────────────────────┐
│                        性能优化策略                              │
└─────────────────────────────────────────────────────────────────┘

1. 缓存策略:
   ├── Redis缓存会话状态
   ├── 内存缓存场景配置
   └── 本地缓存API响应

2. 异步处理:
   ├── 异步API调用
   ├── 异步超时检查
   └── 异步日志记录

3. 连接池:
   ├── HTTP连接池
   ├── Redis连接池
   └── 数据库连接池

4. 批量操作:
   ├── 批量保存学习记录
   ├── 批量更新状态
   └── 批量日志写入
```
