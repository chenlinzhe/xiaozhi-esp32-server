
    # async def _process_teaching_response(self, user_id: str, user_text: str,
    #                                      session_data: Dict[str, Any],
    #                                      child_name: str) -> Dict[str, Any]:
    #     """å¤„ç†æ•™å­¦å›å¤ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå®ç°å®Œæ•´çš„æ­¥éª¤é…ç½®å¤„ç†æµç¨‹"""
    #     try:
    #         self.logger.info(f"=== å¼€å§‹å¤„ç†æ•™å­¦å›å¤ ===")
    #         self.logger.info(f"ç”¨æˆ·ID: {user_id}")
    #         self.logger.info(f"ç”¨æˆ·è¾“å…¥: {user_text}")
    #         self.logger.info(f"ä¼šè¯æ•°æ®: {session_data}")
    #         self.logger.info(f"å„¿ç«¥å§“å: {child_name}")

    #         # è·å–å½“å‰æ­¥éª¤ä¿¡æ¯
    #         scenario_id = session_data.get("scenario_id")
    #         current_step_index = session_data.get("current_step", 0)
    #         self.logger.info(f"åœºæ™¯ID: {scenario_id}, å½“å‰æ­¥éª¤ç´¢å¼•: {current_step_index}")

    #         # è·å–åœºæ™¯æ­¥éª¤
    #         self.logger.info(f"æ­£åœ¨è·å–åœºæ™¯æ­¥éª¤: scenario_id={scenario_id}")
    #         steps = await self.dialogue_service._get_scenario_steps(scenario_id)
    #         self.logger.info(f"è·å–åˆ° {len(steps) if steps else 0} ä¸ªåœºæ™¯æ­¥éª¤")

    #         if not steps or current_step_index >= len(steps):
    #             self.logger.error(
    #                 f"åœºæ™¯æ­¥éª¤é…ç½®é”™è¯¯: steps={len(steps) if steps else 0}, current_step_index={current_step_index}")
    #             return {
    #                 "success": False,
    #                 "error": "åœºæ™¯æ­¥éª¤é…ç½®é”™è¯¯"
    #             }

    #         # æ„å»ºå®Œæ•´çš„sessionæ•°æ®ä¾›è¯„ä¼°ä½¿ç”¨
    #         # ğŸ”¥ æ›´æ–°session_dataä¸­çš„child_nameï¼Œç¡®ä¿åç»­æ­¥éª¤ä½¿ç”¨æ­£ç¡®çš„å§“å
    #         session_data["child_name"] = child_name

    #         full_session = {
    #             **session_data,
    #             "steps": steps,
    #             "child_name": child_name
    #         }
    #         # self.logger.info(f"æ„å»ºå®Œæ•´ä¼šè¯æ•°æ®: {full_session}")

    #         current_step = steps[current_step_index]
    #         # self.logger.info(f"å½“å‰æ­¥éª¤è¯¦æƒ…: {current_step}")

    #         # æ™ºèƒ½è¯„ä¼°ç”¨æˆ·å›å¤
    #         self.logger.info(f"=== å¼€å§‹æ™ºèƒ½è¯„ä¼° ===")
    #         self.logger.info(f"è¯„ä¼°è¾“å…¥: user_text={user_text}")
    #         # self.logger.info(f"è¯„ä¼°ä¼šè¯: {full_session}")

    #         evaluation = self._evaluate_response_with_config(current_step, user_text, session_data)
    #         score = evaluation["score"]

    #         # self.logger.info(f"è¯„ä¼°ç»“æœ: {evaluation}")
    #         self.logger.info(f"è¯„ä¼°åˆ†æ•°: {score}")
    #         # self.logger.info(f"æ˜¯å¦é€šè¿‡: {evaluation.get('is_passed', False)}")

    #         # è®°å½•è¯„ä¼°ç»“æœ
    #         session_data["evaluations"].append(evaluation)
    #         self.logger.info(f"å·²è®°å½•è¯„ä¼°ç»“æœåˆ°ä¼šè¯æ•°æ®")

    #         # æ›´æ–°ç”¨æˆ·å›å¤æ¬¡æ•°ç»Ÿè®¡
    #         session_data["total_user_replies"] = session_data.get("total_user_replies", 0) + 1
    #         current_replies = session_data["total_user_replies"]

    #         # è·å–å½“å‰æ­¥éª¤çš„æœ€å¤§å°è¯•æ¬¡æ•°ï¼ˆä¼˜å…ˆæ­¥éª¤é…ç½®ï¼Œå¤‡ç”¨åœºæ™¯é…ç½®ï¼‰
    #         step_max_attempts = self._get_step_max_attempts(current_step, session_data)
    #         current_step_retry_count = session_data.get("current_step_retry_count", 0)

    #         # åˆ¤æ–­æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹
    #         is_leaf_step = self._is_leaf_step(current_step)

    #         self.logger.info(f"æ­¥éª¤æœ€å¤§å°è¯•æ¬¡æ•°: {step_max_attempts}")
    #         self.logger.info(f"å½“å‰æ­¥éª¤å·²å­¦ä¹ æ¬¡æ•°: {current_step_retry_count + 1}æ¬¡")
    #         self.logger.info(f"æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹: {is_leaf_step}")
    #         self.logger.info(f"ç”¨æˆ·æ€»å›å¤æ¬¡æ•°: {current_replies}")

    #         # æ ¹æ®è¯„ä¼°ç»“æœå†³å®šä¸‹ä¸€æ­¥ - åŒºåˆ†å¶å­èŠ‚ç‚¹å’Œéå¶å­èŠ‚ç‚¹
    #         self.logger.info(f"=== æ ¹æ®è¯„ä¼°ç»“æœå†³å®šä¸‹ä¸€æ­¥ ===")
    #         self.logger.info(f"è¯„ä¼°åˆ†æ•°: {score}")
    #         self.logger.info(f"æ˜¯å¦é€šè¿‡: {evaluation.get('is_passed', False)}")
    #         self.logger.info(f"æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹: {is_leaf_step}")

            
    #         # å¶å­èŠ‚ç‚¹å¤„ç†ï¼šä¸ç®¡ç”¨æˆ·å›å¤ä»€ä¹ˆï¼Œéƒ½é‡å¤è¾“å‡ºAIæ¶ˆæ¯åˆ—è¡¨
    #         # å¶å­èŠ‚ç‚¹çš„ï¼Œä¼šè¿”å›ç»“æœï¼Œç»™å‰ç«¯ï¼›
    #         if is_leaf_step:
                
    #             self.logger.info(f"å¤„ç†å¶å­èŠ‚ç‚¹é€»è¾‘ - é‡å¤è¾“å‡ºAIæ¶ˆæ¯åˆ—è¡¨")

    #             # å¢åŠ å½“å‰æ­¥éª¤é‡è¯•æ¬¡æ•°
    #             session_data["current_step_retry_count"] = current_step_retry_count + 1
    #             self.logger.info(
    #                 f"å¶å­èŠ‚ç‚¹å¢åŠ é‡è¯•æ¬¡æ•°: {session_data['current_step_retry_count']}/{step_max_attempts}")

    #             # æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°
    #             if session_data["current_step_retry_count"] >= step_max_attempts:
    #                 self.logger.warning(f"å¶å­èŠ‚ç‚¹è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œç»“æŸæ•™å­¦")
    #                 final_score = self._calculate_final_score(session_data)
    #                 session_data["completed"] = True
    #                 session_data["final_score"] = final_score
    #                 session_data["completion_reason"] = "leaf_step_max_attempts_exceeded"

    #                 # ä¿å­˜ä¼šè¯æ•°æ®
    #                 self.redis_client.set_session_data(f"teaching_{user_id}", session_data)

    #                 # åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼
    #                 self.set_user_chat_status(user_id, "free_mode")

    #                 # âš ï¸ æ–°å¢ï¼šç«‹å³æ¸…ç†æ•™å­¦ä¼šè¯æ•°æ®
    #                 self.redis_client.delete_session_data(f"teaching_{user_id}")
    #                 self.logger.info(f"å·²æ¸…ç†æ•™å­¦ä¼šè¯æ•°æ®: teaching_{user_id}")

    #                 return {
    #                     "success": True,
    #                     "action": "completed",
    #                     "reason": "leaf_step_max_attempts_exceeded",
    #                     "ai_message": f"{child_name}å°æœ‹å‹ä½ çœŸæ£’ï¼ä½ å·²ç»å­¦ä¹ äº†{current_step_retry_count + 1}æ¬¡ï¼Œå‡ºè‰²åœ°å®Œæˆäº†å­¦ä¹ ä»»åŠ¡,é€ä½ ä¸€æœµå°çº¢èŠ±!æ•™å­¦ç»“æŸï¼Œæœ€ç»ˆå¾—åˆ†ï¼š{final_score}åˆ†ã€‚",
    #                     "final_score": final_score,
    #                     "total_attempts": current_step_retry_count + 1,
    #                     "max_attempts": step_max_attempts
    #                 }
                
                
    #             # å¶å­èŠ‚ç‚¹æœªè¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œè¿˜åœ¨å¾ªç¯ä¸­ï¼Œæ¯æ¬¡è¾“å‡ºä¸€ç»„AIæ¶ˆæ¯åˆ—è¡¨
    #             else:
                    
    #                 self.logger.info(
    #                     f"å¶å­èŠ‚ç‚¹é‡å¤è¾“å‡ºAIæ¶ˆæ¯åˆ—è¡¨ï¼Œé‡è¯•æ¬¡æ•°: {session_data['current_step_retry_count']}/{step_max_attempts}")

    #                 # è·å–æ­¥éª¤çš„æ¶ˆæ¯åˆ—
    #                 step_id = current_step.get("stepId")
    #                 message_list = None
    #                 if step_id:
    #                     message_list = self._get_step_message_list(step_id)
    #                     self.logger.info(
    #                         f"è·å–åˆ°æ­¥éª¤ {step_id} çš„æ¶ˆæ¯åˆ—è¡¨: {len(message_list) if message_list else 0} æ¡æ¶ˆæ¯")

    #                 # è®¾ç½®ç­‰å¾…å“åº”çŠ¶æ€
    #                 session_data["waiting_for_response"] = True
    #                 session_data["wait_start_time"] = time.time()
    #                 session_data["warning_sent"] = False
    #                 session_data["final_reminder_sent"] = False

    #                 # ä¿å­˜ä¼šè¯æ•°æ®
    #                 self.redis_client.set_session_data(f"teaching_{user_id}", session_data)

    #                 # æ„å»ºè¿”å›ç»“æœ
    #                 result = {
    #                     "success": True,
    #                     "action": "retry_current_step",
    #                     "session_id": f"teaching_{user_id}",
    #                     "current_step": current_step,
    #                     "evaluation": evaluation,
    #                     "message": f"è®©æˆ‘ä»¬å†è¯•ä¸€æ¬¡ï¼š{evaluation['feedback']}",
    #                     "timeoutSeconds": current_step.get("timeoutSeconds", self.WAIT_TIME_MAX),
    #                     "retry_count": session_data["current_step_retry_count"],
    #                     "max_attempts": step_max_attempts,
    #                     "is_leaf_step": True
    #                 }

    #                 # å¦‚æœæœ‰æ¶ˆæ¯åˆ—è¡¨ï¼Œæ·»åŠ åˆ°è¿”å›ç»“æœä¸­
    #                 if message_list:
    #                     result["message_list"] = message_list
    #                     result["message_count"] = len(message_list)
    #                     self.logger.info(f"å¶å­èŠ‚ç‚¹è¿”å›æ¶ˆæ¯åˆ—è¡¨ï¼Œæ¶ˆæ¯æ•°é‡: {len(message_list)}")

    #                 return result
            
            
            
    #         # éå¶å­èŠ‚ç‚¹å¤„ç†ï¼šä½¿ç”¨åˆ†æ”¯é…ç½®ï¼Œè¿™é‡Œä¸ä¼šè¿”å›ï¼Œæ˜¯ç»§ç»­èµ°æµç¨‹ï¼›
    #         else:
                
    #             self.logger.info(f"å¤„ç†éå¶å­èŠ‚ç‚¹é€»è¾‘")

    #             # æ ¹æ®è¯„ä¼°åˆ†æ•°å’ŒæˆåŠŸæ¡ä»¶åˆ†æ”¯é…ç½®å†³å®šè·³è½¬
    #             next_step_id = None
    #             branch_type = None

    #             if score >= 90:
    #                 # å®Œå…¨åŒ¹é…åˆ†æ”¯ (åˆ†æ•° >= 90)
    #                 next_step_id = current_step.get("perfectMatchNextStepId") or current_step.get("exactMatchStepId")
    #                 branch_type = "perfect_match"
    #                 self.logger.info(f"å®Œå…¨åŒ¹é…åˆ†æ”¯ï¼Œè·³è½¬æ­¥éª¤ID: {next_step_id}")
    #             elif score >= 60:
    #                 # éƒ¨åˆ†åŒ¹é…åˆ†æ”¯ (60 <= åˆ†æ•° < 90)
    #                 next_step_id = current_step.get("partialMatchNextStepId") or current_step.get("partialMatchStepId")
    #                 branch_type = "partial_match"
    #                 self.logger.info(f"éƒ¨åˆ†åŒ¹é…åˆ†æ”¯ï¼Œè·³è½¬æ­¥éª¤ID: {next_step_id}")
    #             else:
    #                 # å®Œå…¨ä¸åŒ¹é…åˆ†æ”¯ (åˆ†æ•° < 60)
    #                 next_step_id = current_step.get("noMatchNextStepId") or current_step.get("noMatchStepId")
    #                 branch_type = "no_match"
    #                 self.logger.info(f"å®Œå…¨ä¸åŒ¹é…åˆ†æ”¯ï¼Œè·³è½¬æ­¥éª¤ID: {next_step_id}")

    #             # é‡ç½®å½“å‰æ­¥éª¤é‡è¯•æ¬¡æ•°ï¼ˆè¿›å…¥æ–°æ­¥éª¤æ—¶é‡ç½®ï¼‰
    #             session_data["current_step_retry_count"] = 0

    #         # ç»§ç»­èµ°æµç¨‹ï¼ˆéå¶å­ç»“ç‚¹çš„)ï¼Œæ ¹æ®åˆ†æ”¯é…ç½®å†³å®šè·³è½¬
    #         # å¦‚æœéå¶å­ç»“ç‚¹ï¼Œæœ‰åˆ†æ”¯çš„

    #         if next_step_id:
    #             self.logger.info(f"æ ¹æ®{branch_type}åˆ†æ”¯é…ç½®ï¼Œè·³è½¬åˆ°æ­¥éª¤ID: {next_step_id}")
    #             # æŸ¥æ‰¾æŒ‡å®šçš„ä¸‹ä¸€æ­¥éª¤
    #             next_step_index = self._find_step_by_id(steps, next_step_id)
    #             if next_step_index is not None:
    #                 session_data["current_step"] = next_step_index
    #                 self.logger.info(f"è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤: {next_step_index}")
    #             else:
    #                 # å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„æ­¥éª¤ï¼Œå°è¯•å›é€€åˆ°ä¸‹ä¸€ä¸ªæ­¥éª¤
    #                 current_step_index = session_data.get("current_step", 0)
    #                 next_step_index = current_step_index + 1

    #                 if next_step_index < len(steps):
    #                     self.logger.warning(
    #                         f"æœªæ‰¾åˆ°æŒ‡å®šçš„ä¸‹ä¸€æ­¥éª¤ID: {next_step_id}ï¼Œå›é€€åˆ°ä¸‹ä¸€ä¸ªæ­¥éª¤: {next_step_index}")
    #                     session_data["current_step"] = next_step_index
    #                     self.logger.info(f"å›é€€è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ­¥éª¤: {next_step_index}")
    #                 else:
    #                     self.logger.warning(f"æœªæ‰¾åˆ°æŒ‡å®šçš„ä¸‹ä¸€æ­¥éª¤ID: {next_step_id}ï¼Œä¸”å·²åˆ°è¾¾æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œæ•™å­¦ç»“æŸ")
    #                     # å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„æ­¥éª¤ä¸”å·²åˆ°è¾¾æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œç»“æŸæ•™å­¦
    #                     final_score = self._calculate_final_score(session_data)
    #                     session_data["completed"] = True
    #                     session_data["final_score"] = final_score
    #                     session_data["completion_reason"] = "branch_step_not_found"

    #                     # ä¿å­˜ä¼šè¯æ•°æ®
    #                     self.redis_client.set_session_data(f"teaching_{user_id}", session_data)

    #                     # åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼
    #                     self.set_user_chat_status(user_id, "free_mode")

    #                     return {
    #                         "success": True,
    #                         "action": "completed",
    #                         "reason": "branch_step_not_found",
    #                         "ai_message": f"æ•™å­¦å®Œæˆï¼Œæœ€ç»ˆå¾—åˆ†ï¼š{final_score}åˆ†ã€‚",
    #                         "final_score": final_score
    #                     }

    #         # å¦‚æœéå¶å­ç»“ç‚¹ï¼Œæ²¡æœ‰åˆ†æ”¯çš„ï¼Œç›´æ¥ç»“æŸæ•™å­¦
    #         else:
                
    #             self.logger.warning(f"æ²¡æœ‰é…ç½®{branch_type}åˆ†æ”¯è·³è½¬ï¼Œæ•™å­¦ç»“æŸ")
    #             final_score = self._calculate_final_score(session_data)
    #             session_data["completed"] = True
    #             session_data["final_score"] = final_score
    #             session_data["completion_reason"] = "no_branch_config"

    #             # ä¿å­˜ä¼šè¯æ•°æ®
    #             self.redis_client.set_session_data(f"teaching_{user_id}", session_data)

    #             # åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼
    #             self.set_user_chat_status(user_id, "free_mode")

    #             return {
    #                 "success": True,
    #                 "action": "completed",
    #                 "reason": "no_branch_config",
    #                 "ai_message": f"æ•™å­¦å®Œæˆï¼Œæœ€ç»ˆå¾—åˆ†ï¼š{final_score}åˆ†ã€‚",
    #                 "final_score": final_score
    #             }



    #         # æ‰§è¡Œåœºæ™¯: éå¶å­èŠ‚ç‚¹ï¼Œæœ‰æœ‰æ•ˆçš„ next_step_idï¼Œæ‰¾åˆ°äº†æ­¥éª¤ç´¢å¼•ï¼Œ
    #         # ä¸”æœªåˆ°è¾¾æ‰€æœ‰æ­¥éª¤æœ«å°¾ï¼ˆe.g., æ­£å¸¸æ­¥éª¤è·³è½¬æ—¶ï¼‰ã€‚


    #         # è®¾ç½®ç­‰å¾…å“åº”çŠ¶æ€
    #         session_data["waiting_for_response"] = True
    #         session_data["wait_start_time"] = time.time()
    #         session_data["warning_sent"] = False
    #         session_data["final_reminder_sent"] = False
    #         self.logger.info(f"æ›´æ–°æ­¥éª¤ç´¢å¼•: {session_data['current_step']}")
    #         self.logger.info(
    #             f"è®¾ç½®ç­‰å¾…å“åº”çŠ¶æ€: waiting_for_response=True, wait_start_time={session_data['wait_start_time']}")

    #         # æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰æ­¥éª¤
    #         if session_data["current_step"] >= len(steps):
    #             self.logger.info(f"å·²å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼Œæ•™å­¦ç»“æŸ")
    #             # æ•™å­¦å®Œæˆ
    #             final_score = self._calculate_final_score(session_data)
    #             session_data["completed"] = True
    #             session_data["final_score"] = final_score
    #             self.logger.info(f"æœ€ç»ˆå¾—åˆ†: {final_score}")

    #             # ä¿å­˜ä¼šè¯æ•°æ®
    #             self.redis_client.set_session_data(f"teaching_{user_id}", session_data)
    #             self.logger.info(f"å·²ä¿å­˜å®ŒæˆçŠ¶æ€çš„ä¼šè¯æ•°æ®")

    #             # ğŸ”¥ åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼
    #             self.set_user_chat_status(user_id, "free_mode")
    #             self.logger.info(f"âœ… å·²åˆ‡æ¢ç”¨æˆ· {user_id} åˆ°è‡ªç”±æ¨¡å¼")

    #             # è·å–æœ€åä¸€ä¸ªæ­¥éª¤çš„é¼“åŠ±è¯
    #             last_step_index = session_data["current_step"] - 1
    #             encouragement_words = ''
    #             if last_step_index >= 0 and last_step_index < len(steps):
    #                 last_step = steps[last_step_index]
    #                 encouragement_words = last_step.get('encouragementWords', '')
    #                 self.logger.info(f"------------------æœ€åæ­¥éª¤é¼“åŠ±è¯: {encouragement_words}")

    #             # ç”Ÿæˆå®Œæˆæ¶ˆæ¯
    #             completion_message = self._generate_completion_message(final_score, child_name)
    #             if encouragement_words:
    #                 completion_message = f"{encouragement_words} {completion_message}"
    #             self.logger.info(f"ç”Ÿæˆå®Œæˆæ¶ˆæ¯: {completion_message}")

    #             result = {
    #                 "success": True,
    #                 "action": "completed",
    #                 "session_id": f"teaching_{user_id}",
    #                 "ai_message": completion_message,
    #                 "final_score": final_score,
    #                 "evaluation": evaluation,
    #                 "message": f"æ•™å­¦å®Œæˆï¼æœ€ç»ˆå¾—åˆ†ï¼š{final_score}åˆ†",
    #                 "encouragement_words": encouragement_words
    #             }
    #             self.logger.info(f"è¿”å›å®Œæˆç»“æœ: {result}")
    #             return result

    #         # éå¶å­èŠ‚ç‚¹ã€æœªå®Œæˆæ‰€æœ‰æ­¥éª¤
    #         else:
    #             self.logger.info(f"è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œæ­¥éª¤ç´¢å¼•: {session_data['current_step']}")
    #             # è·å–å½“å‰æ­¥éª¤çš„é¼“åŠ±è¯ï¼ˆåœ¨è¿›å…¥ä¸‹ä¸€æ­¥å‰ï¼‰
    #             current_step_index = session_data["current_step"] - 1  # å½“å‰æ­¥éª¤ç´¢å¼•
    #             if current_step_index >= 0 and current_step_index < len(steps):
    #                 current_step = steps[current_step_index]
    #                 encouragement_words = current_step.get('encouragementWords', '')
    #                 self.logger.info(f"-------------------å½“å‰æ­¥éª¤é¼“åŠ±è¯: {encouragement_words}")
    #             else:
    #                 encouragement_words = ''

    #             # è¿›å…¥ä¸‹ä¸€æ­¥
    #             next_step = steps[session_data["current_step"]]
    #             # ä¸å†ä½¿ç”¨AIæ¶ˆæ¯ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥
    #             self.logger.info(f"è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œæ­¥éª¤: {next_step.get('stepName', 'æœªçŸ¥æ­¥éª¤')}")

    #             # è·å–ä¸‹ä¸€æ­¥çš„è¶…æ—¶æ—¶é—´
    #             timeout_seconds = next_step.get("timeoutSeconds", self.WAIT_TIME_MAX)
    #             self.logger.info(f"ä¸‹ä¸€æ­¥è¶…æ—¶æ—¶é—´: {timeout_seconds}ç§’")

    #             # ä¿å­˜ä¼šè¯æ•°æ®
    #             self.redis_client.set_session_data(f"teaching_{user_id}", session_data)
    #             self.logger.info(f"å·²ä¿å­˜ä¼šè¯æ•°æ®")

    #             # æ ¹æ®åˆ†æ”¯ç±»å‹ç¡®å®šaction
    #             if branch_type == "perfect_match":
    #                 action = "perfect_match_next"
    #             elif branch_type == "partial_match":
    #                 action = "partial_match_next"
    #             elif branch_type == "no_match":
    #                 action = "no_match_next"
    #             else:
    #                 action = "next_step"

    #             result = {
    #                 "success": True,
    #                 "action": action,
    #                 "session_id": f"teaching_{user_id}",
    #                 "current_step": next_step,
    #                 "evaluation": evaluation,
    #                 "message": f"æ ¹æ®{branch_type}åˆ†æ”¯è¿›å…¥ä¸‹ä¸€æ­¥ï¼š{evaluation['feedback']}",
    #                 "timeoutSeconds": timeout_seconds,
    #                 "total_replies": current_replies,

    #                 "max_replies": session_data.get("max_user_replies", 3),
    #                 # "reply_progress": reply_progress,
    #                 # "warning_message": warning_message,
    #                 "branch_type": branch_type
    #             }
    #             self.logger.info(f"è¿”å›ä¸‹ä¸€æ­¥ç»“æœ: {result}")
    #             return result
    #         # æ³¨æ„ï¼šç§»é™¤äº†é‡è¯•é€»è¾‘ï¼Œç°åœ¨ç”¨æˆ·å›å¤åç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥

    #     except Exception as e:
    #         self.logger.error(f"å¤„ç†æ•™å­¦å›å¤å¤±è´¥: {e}", exc_info=True)
    #         # å³ä½¿å‡ºç°å¼‚å¸¸ï¼Œä¹Ÿè¦å°è¯•è®°å½•å›å¤æ¬¡æ•°
    #         try:
    #             session_data = self.redis_client.get_session_data(f"teaching_{user_id}")
    #             if session_data:
    #                 session_data["total_user_replies"] = session_data.get("total_user_replies", 0) + 1
    #                 self.redis_client.set_session_data(f"teaching_{user_id}", session_data)
    #                 self.logger.warning(
    #                     f"å¼‚å¸¸æƒ…å†µä¸‹ä»è®°å½•å›å¤æ¬¡æ•° - ç”¨æˆ·: {user_id}, æ€»å›å¤æ¬¡æ•°: {session_data.get('total_user_replies', 0)}")
    #         except Exception as log_error:
    #             self.logger.error(f"è®°å½•å¼‚å¸¸å›å¤æ¬¡æ•°å¤±è´¥: {str(log_error)}")

    #         return {
    #             "success": False,
    #             "error": f"å¤„ç†æ•™å­¦å›å¤å¤±è´¥: {str(e)}",
    #             "total_replies": session_data.get("total_user_replies", 0) if 'session_data' in locals() else 0
    #         }

 

