<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©æ¨¡å¼ç®¡ç†ç³»ç»Ÿ - è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
        }
        .test-section h2 {
            margin-top: 0;
            color: #444;
            font-size: 20px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }
        .btn-primary { background-color: #4285f4; }
        .btn-success { background-color: #0f9d58; }
        .btn-warning { background-color: #f4b400; }
        .btn-danger { background-color: #db4437; }
        button:hover { opacity: 0.8; }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .connection-panel {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .connection-panel input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 200px;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-connected { background-color: #0f9d58; }
        .status-disconnected { background-color: #db4437; }
        .status-connecting { 
            background-color: #f4b400;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .test-results {
            margin-top: 20px;
        }
        .test-case {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .test-case.passed {
            background-color: #e6f4ea;
            border-left-color: #0f9d58;
        }
        .test-case.failed {
            background-color: #fce8e6;
            border-left-color: #db4437;
        }
        .test-case.running {
            background-color: #fef7e0;
            border-left-color: #f4b400;
        }
        .test-case.pending {
            background-color: #f0f0f0;
            border-left-color: #9e9e9e;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-status {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-passed { background-color: #0f9d58; color: white; }
        .status-failed { background-color: #db4437; color: white; }
        .status-running { background-color: #f4b400; color: white; }
        .status-pending { background-color: #9e9e9e; color: white; }
        .test-details {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #4285f4;
            transition: width 0.3s ease;
        }
        .test-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .mode-display {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .mode-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .mode-teaching {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .mode-free {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .mode-unknown {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        .manual-test-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .manual-test-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .manual-test-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .conversation-log {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: white;
            margin-top: 10px;
        }
        .message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            max-width: 80%;
        }
        .message.user {
            background-color: #e2f2ff;
            margin-left: auto;
            text-align: right;
        }
        .message.server {
            background-color: #f0f0f0;
            margin-right: auto;
        }
        .test-log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #333; }
        .log-success { color: #0f9d58; }
        .log-warning { color: #f4b400; }
        .log-error { color: #db4437; }
    </style>
</head>

<body>
    <div class="container">
        <h1>èŠå¤©æ¨¡å¼ç®¡ç†ç³»ç»Ÿ - è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶</h1>

        <!-- è¿æ¥é…ç½® -->
        <div class="test-section">
            <h2>ğŸ”— æœåŠ¡å™¨è¿æ¥é…ç½®</h2>
            <div class="connection-panel">
                <input type="text" id="serverUrl" value="ws://127.0.0.1:8000/xiaozhi/v1/" 
                       placeholder="WebSocketæœåŠ¡å™¨åœ°å€">
                <input type="text" id="deviceId" value="test_device_001" 
                       placeholder="è®¾å¤‡ID">
                <button id="connectBtn" class="btn-primary">è¿æ¥æœåŠ¡å™¨</button>
                <button id="disconnectBtn" class="btn-danger" disabled>æ–­å¼€è¿æ¥</button>
            </div>
            <div class="connection-status">
                <span>è¿æ¥çŠ¶æ€: <span id="connectionStatus">æœªè¿æ¥</span></span>
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span>å½“å‰æ¨¡å¼: <span id="currentMode">æœªçŸ¥</span></span>
                <span>æ¶ˆæ¯ç»Ÿè®¡: æ–‡æœ¬<span id="textCount">0</span> | äºŒè¿›åˆ¶<span id="binaryCount">0</span> | é”™è¯¯<span id="errorCount">0</span></span>
            </div>
        </div>

        <!-- æµ‹è¯•æ§åˆ¶ -->
        <div class="test-section">
            <h2>ğŸ§ª æµ‹è¯•æ§åˆ¶</h2>
            <div class="test-controls">
                <button id="runAllTestsBtn" class="btn-success" disabled>è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                <button id="runBasicTestsBtn" class="btn-primary" disabled>è¿è¡ŒåŸºç¡€æµ‹è¯•</button>
                <button id="runModeTestsBtn" class="btn-primary" disabled>è¿è¡Œæ¨¡å¼åˆ‡æ¢æµ‹è¯•</button>
                <button id="runTimeoutTestsBtn" class="btn-warning" disabled>è¿è¡Œè¶…æ—¶æµ‹è¯•</button>
                <button id="stopTestsBtn" class="btn-danger" disabled>åœæ­¢æµ‹è¯•</button>
                <button id="clearResultsBtn" class="btn-warning">æ¸…é™¤ç»“æœ</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div class="test-summary">
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalTests">0</span>
                        <span class="stat-label">æ€»æµ‹è¯•æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="passedTests">0</span>
                        <span class="stat-label">é€šè¿‡</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="failedTests">0</span>
                        <span class="stat-label">å¤±è´¥</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="runningTests">0</span>
                        <span class="stat-label">è¿è¡Œä¸­</span>
                    </div>
                </div>
            </div>
            <div class="test-results" id="testResults">
                <!-- æµ‹è¯•ç”¨ä¾‹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ‰‹åŠ¨æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ–±ï¸ æ‰‹åŠ¨æµ‹è¯•</h2>
            <div class="manual-test-panel">
                <div class="mode-display">
                    <span>å½“å‰æ¨¡å¼:</span>
                    <span class="mode-badge mode-unknown" id="modeBadge">æœªçŸ¥</span>
                </div>
                <div class="manual-test-input">
                    <input type="text" id="manualInput" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." disabled>
                    <button id="sendManualBtn" class="btn-primary" disabled>å‘é€</button>
                    <button id="switchTeachingBtn" class="btn-warning" disabled>åˆ‡æ¢åˆ°æ•™å­¦æ¨¡å¼</button>
                    <button id="switchFreeBtn" class="btn-success" disabled>åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼</button>
                    <button id="checkTimeoutBtn" class="btn-warning" disabled>æ£€æŸ¥è¶…æ—¶</button>
                </div>
                <div class="conversation-log" id="conversationLog">
                    <div class="message server">ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼Œè¯·è¿æ¥æœåŠ¡å™¨å¼€å§‹æµ‹è¯•...</div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ—¥å¿— -->
        <div class="test-section">
            <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
            <div class="test-log" id="detailedLogContent">
                <!-- è¯¦ç»†æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let websocket = null;
        let isConnected = false;
        let currentMode = 'unknown';
        let testResults = [];
        let isTestRunning = false;
        let messageStats = {
            text: 0,
            binary: 0,
            errors: 0
        };

        // æµ‹è¯•ç”¨ä¾‹å®šä¹‰
        const testCases = {
            basic: [
                {
                    id: 'connection_test',
                    name: 'æœåŠ¡å™¨è¿æ¥æµ‹è¯•',
                    description: 'æµ‹è¯•WebSocketè¿æ¥æ˜¯å¦æ­£å¸¸å»ºç«‹',
                    run: async () => {
                        return new Promise((resolve) => {
                            if (websocket && websocket.readyState === WebSocket.OPEN) {
                                resolve({ success: true, message: 'è¿æ¥æˆåŠŸ' });
                            } else {
                                resolve({ success: false, message: 'è¿æ¥å¤±è´¥' });
                            }
                        });
                    }
                },
                {
                    id: 'hello_test',
                    name: 'Helloæ¡æ‰‹æµ‹è¯•',
                    description: 'æµ‹è¯•ä¸æœåŠ¡å™¨çš„Helloæ¡æ‰‹åè®®',
                    run: async () => {
                        return new Promise((resolve) => {
                            const helloMessage = {
                                type: 'hello',
                                device_id: document.getElementById('deviceId').value,
                                device_name: 'Test Device',
                                device_mac: document.getElementById('deviceId').value,
                                token: 'test-token',
                                features: { mcp: true }
                            };

                            const timeout = setTimeout(() => {
                                resolve({ success: false, message: 'Helloå“åº”è¶…æ—¶' });
                            }, 5000);

                            const originalOnMessage = websocket.onmessage;
                            websocket.onmessage = (event) => {
                                // è·³è¿‡äºŒè¿›åˆ¶æ•°æ®
                                if (event.data instanceof ArrayBuffer) {
                                    return;
                                }
                                
                                try {
                                    const response = JSON.parse(event.data);
                                    if (response.type === 'hello' && response.session_id) {
                                        clearTimeout(timeout);
                                        websocket.onmessage = originalOnMessage;
                                        resolve({ success: true, message: `æ¡æ‰‹æˆåŠŸï¼Œä¼šè¯ID: ${response.session_id}` });
                                    }
                                } catch (e) {
                                    // å¿½ç•¥éJSONæ¶ˆæ¯
                                }
                            };

                            websocket.send(JSON.stringify(helloMessage));
                        });
                    }
                }
            ],
            modeSwitch: [
                {
                    id: 'switch_to_teaching_test',
                    name: 'åˆ‡æ¢åˆ°æ•™å­¦æ¨¡å¼æµ‹è¯•',
                    description: 'æµ‹è¯•ä»è‡ªç”±æ¨¡å¼åˆ‡æ¢åˆ°æ•™å­¦æ¨¡å¼',
                    run: async () => {
                        return new Promise((resolve) => {
                            const chatMessage = {
                                type: 'dialogue',
                                action: 'chat',
                                user_text: 'åˆ‡æ¢åˆ°æ•™å­¦æ¨¡å¼',
                                user_id: document.getElementById('deviceId').value,
                                child_name: 'å°æœ‹å‹'
                            };

                            const timeout = setTimeout(() => {
                                resolve({ success: false, message: 'æ¨¡å¼åˆ‡æ¢å“åº”è¶…æ—¶' });
                            }, 5000);

                            const originalOnMessage = websocket.onmessage;
                            websocket.onmessage = (event) => {
                                // è·³è¿‡äºŒè¿›åˆ¶æ•°æ®
                                if (event.data instanceof ArrayBuffer) {
                                    return;
                                }
                                
                                try {
                                    const response = JSON.parse(event.data);
                                    if (response.type === 'dialogue' && response.success) {
                                        clearTimeout(timeout);
                                        websocket.onmessage = originalOnMessage;
                                        if (response.action === 'mode_switch' && response.mode === 'teaching_mode') {
                                            resolve({ success: true, message: 'æˆåŠŸåˆ‡æ¢åˆ°æ•™å­¦æ¨¡å¼' });
                                        } else {
                                            resolve({ success: false, message: 'æ¨¡å¼åˆ‡æ¢å¤±è´¥' });
                                        }
                                    }
                                } catch (e) {
                                    // å¿½ç•¥éJSONæ¶ˆæ¯
                                }
                            };

                            websocket.send(JSON.stringify(chatMessage));
                        });
                    }
                },
                {
                    id: 'switch_to_free_test',
                    name: 'åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼æµ‹è¯•',
                    description: 'æµ‹è¯•ä»æ•™å­¦æ¨¡å¼åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼',
                    run: async () => {
                        return new Promise((resolve) => {
                            const chatMessage = {
                                type: 'dialogue',
                                action: 'chat',
                                user_text: 'åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼',
                                user_id: document.getElementById('deviceId').value,
                                child_name: 'å°æœ‹å‹'
                            };

                            const timeout = setTimeout(() => {
                                resolve({ success: false, message: 'æ¨¡å¼åˆ‡æ¢å“åº”è¶…æ—¶' });
                            }, 5000);

                            const originalOnMessage = websocket.onmessage;
                            websocket.onmessage = (event) => {
                                // è·³è¿‡äºŒè¿›åˆ¶æ•°æ®
                                if (event.data instanceof ArrayBuffer) {
                                    return;
                                }
                                
                                try {
                                    const response = JSON.parse(event.data);
                                    if (response.type === 'dialogue' && response.success) {
                                        clearTimeout(timeout);
                                        websocket.onmessage = originalOnMessage;
                                        if (response.action === 'mode_switch' && response.mode === 'free_mode') {
                                            resolve({ success: true, message: 'æˆåŠŸåˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼' });
                                        } else {
                                            resolve({ success: false, message: 'æ¨¡å¼åˆ‡æ¢å¤±è´¥' });
                                        }
                                    }
                                } catch (e) {
                                    // å¿½ç•¥éJSONæ¶ˆæ¯
                                }
                            };

                            websocket.send(JSON.stringify(chatMessage));
                        });
                    }
                }
            ],
            timeout: [
                {
                    id: 'timeout_check_test',
                    name: 'è¶…æ—¶æ£€æŸ¥æµ‹è¯•',
                    description: 'æµ‹è¯•æ•™å­¦ä¼šè¯è¶…æ—¶æ£€æŸ¥åŠŸèƒ½',
                    run: async () => {
                        return new Promise((resolve) => {
                            const timeoutMessage = {
                                type: 'dialogue',
                                action: 'check_timeout',
                                user_id: document.getElementById('deviceId').value
                            };

                            const timeout = setTimeout(() => {
                                resolve({ success: false, message: 'è¶…æ—¶æ£€æŸ¥å“åº”è¶…æ—¶' });
                            }, 5000);

                            const originalOnMessage = websocket.onmessage;
                            websocket.onmessage = (event) => {
                                // è·³è¿‡äºŒè¿›åˆ¶æ•°æ®
                                if (event.data instanceof ArrayBuffer) {
                                    return;
                                }
                                
                                try {
                                    const response = JSON.parse(event.data);
                                    if (response.type === 'dialogue' && response.success) {
                                        clearTimeout(timeout);
                                        websocket.onmessage = originalOnMessage;
                                        resolve({ success: true, message: 'è¶…æ—¶æ£€æŸ¥æˆåŠŸ' });
                                    }
                                } catch (e) {
                                    // å¿½ç•¥éJSONæ¶ˆæ¯
                                }
                            };

                            websocket.send(JSON.stringify(timeoutMessage));
                        });
                    }
                }
            ]
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            updateTestResults();
        });

        // äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            document.getElementById('connectBtn').addEventListener('click', connectToServer);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectFromServer);
            document.getElementById('runAllTestsBtn').addEventListener('click', () => runTests('all'));
            document.getElementById('runBasicTestsBtn').addEventListener('click', () => runTests('basic'));
            document.getElementById('runModeTestsBtn').addEventListener('click', () => runTests('modeSwitch'));
            document.getElementById('runTimeoutTestsBtn').addEventListener('click', () => runTests('timeout'));
            document.getElementById('stopTestsBtn').addEventListener('click', stopTests);
            document.getElementById('clearResultsBtn').addEventListener('click', clearResults);
            
            // æ‰‹åŠ¨æµ‹è¯•
            document.getElementById('sendManualBtn').addEventListener('click', sendManualMessage);
            document.getElementById('switchTeachingBtn').addEventListener('click', () => sendModeSwitch('teaching'));
            document.getElementById('switchFreeBtn').addEventListener('click', () => sendModeSwitch('free'));
            document.getElementById('checkTimeoutBtn').addEventListener('click', sendTimeoutCheck);
            
            // å›è½¦å‘é€
            document.getElementById('manualInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendManualMessage();
            });
        }

        // è¿æ¥æœåŠ¡å™¨
        async function connectToServer() {
            const url = document.getElementById('serverUrl').value.trim();
            const deviceId = document.getElementById('deviceId').value.trim();
            
            if (!url || !deviceId) {
                log('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€å’Œè®¾å¤‡ID', 'error');
                return;
            }

            try {
                updateConnectionStatus('connecting');
                
                // æ„å»ºè¿æ¥URL
                const connUrl = new URL(url);
                connUrl.searchParams.append('device-id', deviceId);
                connUrl.searchParams.append('client-id', 'test_client');

                websocket = new WebSocket(connUrl.toString());
                websocket.binaryType = 'arraybuffer';

                websocket.onopen = () => {
                    updateConnectionStatus('connected');
                    log('WebSocketè¿æ¥æˆåŠŸ', 'success');
                    enableTestControls();
                    // é‡ç½®æ¶ˆæ¯ç»Ÿè®¡
                    messageStats = { text: 0, binary: 0, errors: 0 };
                    updateMessageStats();
                };

                websocket.onclose = () => {
                    updateConnectionStatus('disconnected');
                    log('WebSocketè¿æ¥æ–­å¼€', 'warning');
                    disableTestControls();
                };

                websocket.onerror = (error) => {
                    updateConnectionStatus('disconnected');
                    log(`WebSocketè¿æ¥é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    disableTestControls();
                };

                websocket.onmessage = handleWebSocketMessage;

            } catch (error) {
                updateConnectionStatus('disconnected');
                log(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                disableTestControls();
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnectFromServer() {
            if (websocket) {
                websocket.close();
            }
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(event) {
            // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
            if (event.data instanceof ArrayBuffer) {
                // å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆéŸ³é¢‘æ•°æ®ç­‰ï¼‰
                messageStats.binary++;
                log(`æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®ï¼Œå¤§å°: ${event.data.byteLength} å­—èŠ‚`, 'info');
                updateMessageStats();
                return;
            }
            
            // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
            try {
                const message = JSON.parse(event.data);
                messageStats.text++;
                log(`æ”¶åˆ°æ¶ˆæ¯ [${message.type}]: ${JSON.stringify(message)}`, 'info');

                if (message.type === 'dialogue') {
                    handleDialogueMessage(message);
                } else if (message.type === 'hello') {
                    log(`Helloå“åº”: ${JSON.stringify(message)}`, 'success');
                } else if (message.type === 'llm') {
                    addConversationMessage(message.text, false);
                } else if (message.type === 'stt') {
                    addConversationMessage(`[è¯­éŸ³è¯†åˆ«] ${message.text}`, true);
                } else if (message.type === 'tts') {
                    handleTTSMessage(message);
                } else {
                    log(`æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${message.type}`, 'warning');
                }
            } catch (error) {
                messageStats.errors++;
                log(`æ¶ˆæ¯è§£æé”™è¯¯: ${error.message}`, 'error');
            }
            
            updateMessageStats();
        }

        // å¤„ç†å¯¹è¯æ¶ˆæ¯
        function handleDialogueMessage(message) {
            if (message.success) {
                if (message.action === 'mode_switch') {
                    updateCurrentMode(message.mode);
                    if (message.ai_message) {
                        addConversationMessage(message.ai_message, false);
                    }
                    log(`æ¨¡å¼åˆ‡æ¢æˆåŠŸ: ${message.mode}`, 'success');
                } else if (message.action === 'start_teaching') {
                    updateCurrentMode('teaching_mode');
                    if (message.ai_message) {
                        addConversationMessage(message.ai_message, false);
                    }
                    log(`å¼€å§‹æ•™å­¦æ¨¡å¼: ${message.scenario_name}`, 'success');
                } else if (message.action === 'timeout') {
                    if (message.ai_message) {
                        addConversationMessage(message.ai_message, false);
                    }
                    log('æ£€æµ‹åˆ°æ•™å­¦è¶…æ—¶', 'warning');
                } else if (message.action === 'no_timeout') {
                    log('æ•™å­¦ä¼šè¯æœªè¶…æ—¶', 'info');
                }
            } else {
                log(`å¯¹è¯å¤„ç†å¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // å¤„ç†TTSæ¶ˆæ¯
        function handleTTSMessage(message) {
            if (message.state === 'start') {
                log('TTSå¼€å§‹æ’­æ”¾', 'info');
            } else if (message.state === 'sentence_start') {
                log(`TTSå¥å­å¼€å§‹: ${message.text}`, 'info');
            } else if (message.state === 'sentence_end') {
                log('TTSå¥å­ç»“æŸ', 'info');
            } else if (message.state === 'end') {
                log('TTSæ’­æ”¾ç»“æŸ', 'info');
            } else {
                log(`TTSçŠ¶æ€: ${message.state}`, 'info');
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const indicator = document.getElementById('statusIndicator');
            
            isConnected = status === 'connected';
            
            switch (status) {
                case 'connected':
                    statusElement.textContent = 'å·²è¿æ¥';
                    indicator.className = 'status-indicator status-connected';
                    break;
                case 'connecting':
                    statusElement.textContent = 'è¿æ¥ä¸­...';
                    indicator.className = 'status-indicator status-connecting';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'æœªè¿æ¥';
                    indicator.className = 'status-indicator status-disconnected';
                    break;
            }
        }

        // æ›´æ–°å½“å‰æ¨¡å¼
        function updateCurrentMode(mode) {
            currentMode = mode;
            document.getElementById('currentMode').textContent = mode;
            
            const badge = document.getElementById('modeBadge');
            badge.className = 'mode-badge';
            
            if (mode === 'teaching_mode') {
                badge.className += ' mode-teaching';
                badge.textContent = 'æ•™å­¦æ¨¡å¼';
            } else if (mode === 'free_mode') {
                badge.className += ' mode-free';
                badge.textContent = 'è‡ªç”±æ¨¡å¼';
            } else {
                badge.className += ' mode-unknown';
                badge.textContent = 'æœªçŸ¥';
            }
        }

        // æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡
        function updateMessageStats() {
            document.getElementById('textCount').textContent = messageStats.text;
            document.getElementById('binaryCount').textContent = messageStats.binary;
            document.getElementById('errorCount').textContent = messageStats.errors;
        }

        // å¯ç”¨æµ‹è¯•æ§åˆ¶
        function enableTestControls() {
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('runAllTestsBtn').disabled = false;
            document.getElementById('runBasicTestsBtn').disabled = false;
            document.getElementById('runModeTestsBtn').disabled = false;
            document.getElementById('runTimeoutTestsBtn').disabled = false;
            document.getElementById('manualInput').disabled = false;
            document.getElementById('sendManualBtn').disabled = false;
            document.getElementById('switchTeachingBtn').disabled = false;
            document.getElementById('switchFreeBtn').disabled = false;
            document.getElementById('checkTimeoutBtn').disabled = false;
        }

        // ç¦ç”¨æµ‹è¯•æ§åˆ¶
        function disableTestControls() {
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('runAllTestsBtn').disabled = true;
            document.getElementById('runBasicTestsBtn').disabled = true;
            document.getElementById('runModeTestsBtn').disabled = true;
            document.getElementById('runTimeoutTestsBtn').disabled = true;
            document.getElementById('manualInput').disabled = true;
            document.getElementById('sendManualBtn').disabled = true;
            document.getElementById('switchTeachingBtn').disabled = true;
            document.getElementById('switchFreeBtn').disabled = true;
            document.getElementById('checkTimeoutBtn').disabled = true;
        }

        // è¿è¡Œæµ‹è¯•
        async function runTests(testType) {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥æœåŠ¡å™¨', 'error');
                return;
            }

            if (isTestRunning) {
                log('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ', 'warning');
                return;
            }

            isTestRunning = true;
            document.getElementById('stopTestsBtn').disabled = false;

            let testsToRun = [];
            
            if (testType === 'all') {
                testsToRun = [
                    ...testCases.basic,
                    ...testCases.modeSwitch,
                    ...testCases.timeout
                ];
            } else if (testType === 'basic') {
                testsToRun = testCases.basic;
            } else if (testType === 'modeSwitch') {
                testsToRun = testCases.modeSwitch;
            } else if (testType === 'timeout') {
                testsToRun = testCases.timeout;
            }

            // åˆå§‹åŒ–æµ‹è¯•ç»“æœ
            testResults = testsToRun.map(test => ({
                ...test,
                status: 'pending',
                result: null,
                timestamp: null
            }));

            updateTestResults();
            updateProgress();

            log(`å¼€å§‹è¿è¡Œ ${testType} æµ‹è¯•ï¼Œå…± ${testsToRun.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`, 'info');

            // é€ä¸ªè¿è¡Œæµ‹è¯•
            for (let i = 0; i < testResults.length; i++) {
                if (!isTestRunning) break;

                const test = testResults[i];
                test.status = 'running';
                test.timestamp = new Date();
                updateTestResults();
                updateProgress();

                log(`è¿è¡Œæµ‹è¯•: ${test.name}`, 'info');

                try {
                    const result = await test.run();
                    test.result = result;
                    test.status = result.success ? 'passed' : 'failed';
                    log(`æµ‹è¯• ${test.name}: ${result.success ? 'é€šè¿‡' : 'å¤±è´¥'} - ${result.message}`, 
                        result.success ? 'success' : 'error');
                } catch (error) {
                    test.result = { success: false, message: error.message };
                    test.status = 'failed';
                    log(`æµ‹è¯• ${test.name} å¼‚å¸¸: ${error.message}`, 'error');
                }

                updateTestResults();
                updateProgress();

                // æµ‹è¯•é—´éš”
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            isTestRunning = false;
            document.getElementById('stopTestsBtn').disabled = true;

            const passed = testResults.filter(t => t.status === 'passed').length;
            const failed = testResults.filter(t => t.status === 'failed').length;
            
            log(`æµ‹è¯•å®Œæˆ: é€šè¿‡ ${passed} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`, 
                failed === 0 ? 'success' : 'warning');
        }

        // åœæ­¢æµ‹è¯•
        function stopTests() {
            isTestRunning = false;
            document.getElementById('stopTestsBtn').disabled = true;
            log('æµ‹è¯•å·²åœæ­¢', 'warning');
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testResults = [];
            updateTestResults();
            updateProgress();
            log('æµ‹è¯•ç»“æœå·²æ¸…é™¤', 'info');
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
        function updateTestResults() {
            const container = document.getElementById('testResults');
            container.innerHTML = '';

            testResults.forEach(test => {
                const testElement = document.createElement('div');
                testElement.className = `test-case ${test.status}`;
                
                const statusText = {
                    'pending': 'ç­‰å¾…ä¸­',
                    'running': 'è¿è¡Œä¸­',
                    'passed': 'é€šè¿‡',
                    'failed': 'å¤±è´¥'
                };

                testElement.innerHTML = `
                    <h4>
                        <span class="test-status status-${test.status}">${statusText[test.status]}</span>
                        ${test.name}
                    </h4>
                    <div class="test-details">
                        <div><strong>æè¿°:</strong> ${test.description}</div>
                        ${test.result ? `<div><strong>ç»“æœ:</strong> ${test.result.message}</div>` : ''}
                        ${test.timestamp ? `<div><strong>æ—¶é—´:</strong> ${test.timestamp.toLocaleTimeString()}</div>` : ''}
                    </div>
                `;

                container.appendChild(testElement);
            });

            // æ›´æ–°ç»Ÿè®¡
            const total = testResults.length;
            const passed = testResults.filter(t => t.status === 'passed').length;
            const failed = testResults.filter(t => t.status === 'failed').length;
            const running = testResults.filter(t => t.status === 'running').length;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('runningTests').textContent = running;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            if (testResults.length === 0) {
                document.getElementById('progressFill').style.width = '0%';
                return;
            }

            const completed = testResults.filter(t => t.status === 'passed' || t.status === 'failed').length;
            const progress = (completed / testResults.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // æ‰‹åŠ¨æµ‹è¯•åŠŸèƒ½
        function sendManualMessage() {
            const input = document.getElementById('manualInput');
            const message = input.value.trim();
            
            if (!message || !isConnected) return;

            addConversationMessage(message, true);
            
            const listenMessage = {
                type: 'listen',
                mode: 'manual',
                state: 'detect',
                text: message
            };

            websocket.send(JSON.stringify(listenMessage));
            input.value = '';
        }

        function sendModeSwitch(mode) {
            if (!isConnected) return;

            const modeText = mode === 'teaching' ? 'åˆ‡æ¢åˆ°æ•™å­¦æ¨¡å¼' : 'åˆ‡æ¢åˆ°è‡ªç”±æ¨¡å¼';
            addConversationMessage(modeText, true);

            const chatMessage = {
                type: 'dialogue',
                action: 'chat',
                user_text: modeText,
                user_id: document.getElementById('deviceId').value,
                child_name: 'å°æœ‹å‹'
            };

            websocket.send(JSON.stringify(chatMessage));
        }

        function sendTimeoutCheck() {
            if (!isConnected) return;

            addConversationMessage('æ£€æŸ¥è¶…æ—¶', true);

            const timeoutMessage = {
                type: 'dialogue',
                action: 'check_timeout',
                user_id: document.getElementById('deviceId').value
            };

            websocket.send(JSON.stringify(timeoutMessage));
        }

        // æ·»åŠ å¯¹è¯æ¶ˆæ¯
        function addConversationMessage(text, isUser) {
            const container = document.getElementById('conversationLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'server'}`;
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const container = document.getElementById('detailedLogContent');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
