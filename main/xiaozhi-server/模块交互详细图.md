# 小智ESP32服务器 - 模块交互详细图

## 🔗 模块间交互关系图

```mermaid
graph LR
    subgraph "入口层"
        A[WebSocket连接]
        B[receiveAudioHandle]
        C[intentHandler]
    end
    
    subgraph "核心连接层"
        D[ConnectionHandler]
        E[TeachingHandler]
    end
    
    subgraph "状态管理层"
        F[ChatStatusManager]
        G[Redis客户端]
    end
    
    subgraph "服务层"
        H[DialogueService]
        I[ScenarioManager]
        J[LearningRecordManager]
    end
    
    subgraph "数据层"
        K[管理API]
        L[Redis存储]
        M[数据库]
    end
    
    A --> D
    B --> C
    C --> D
    C --> E
    D --> E
    E --> F
    F --> G
    F --> H
    F --> I
    G --> L
    H --> K
    I --> K
    J --> K
    D --> M
    
    style D fill:#e1f5ff
    style E fill:#fff4e1
    style F fill:#e1ffe1
    style H fill:#f0e1ff
    style I fill:#ffe1f0
```

## 📋 详细功能模块图

```mermaid
mindmap
  root((小智ESP32服务器))
    连接管理
      WebSocket处理
      音频流管理
      用户认证
      设备绑定
    教学场景系统
      场景触发检测
      状态管理
      回复评估
      步骤跳转
      消息发送
    数据处理
      会话数据
      学习记录
      场景配置
      步骤配置
    组件集成
      VAD语音检测
      ASR语音识别
      TTS语音合成
      LLM大模型
      记忆管理
      意图识别
```

## 🔄 完整教学流程时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant WS as WebSocket
    participant CH as ConnectionHandler
    participant IH as IntentHandler
    participant TH as TeachingHandler
    participant CSM as ChatStatusManager
    participant DS as DialogueService
    participant R as Redis
    participant API as 管理API
    participant TTS as TTS系统

    Note over U,TTS: 阶段1: 连接初始化
    U->>WS: 建立连接
    WS->>CH: handle_connection
    CH->>CH: 初始化组件
    CH->>CH: 加载用户信息
    CH->>CH: 初始化TeachingHandler
    CH->>TTS: 发送欢迎语音
    TTS->>U: 播放欢迎语
    
    Note over U,TTS: 阶段2: 场景触发
    U->>WS: 说话（音频）
    WS->>CH: 接收音频
    CH->>CH: ASR识别
    CH->>IH: handle_user_intent
    IH->>IH: 检测场景触发
    IH->>CSM: handle_user_input(user_id, text)
    
    Note over U,TTS: 阶段3: 开始教学会话
    CSM->>R: 检查聊天状态
    R-->>CSM: free_mode
    CSM->>CSM: _start_teaching_session
    CSM->>DS: 获取场景配置
    DS->>API: 获取场景信息
    API-->>DS: 场景数据
    DS->>API: 获取场景步骤
    API-->>DS: 步骤列表
    DS-->>CSM: 场景和步骤数据
    CSM->>R: 创建会话数据
    CSM->>DS: 获取第一步消息
    DS->>API: 获取消息列表
    API-->>DS: 消息列表
    DS-->>CSM: 消息列表
    CSM-->>IH: 返回start_teaching
    IH->>TH: handle_chat_mode
    TH->>TTS: 发送消息列表
    TTS->>U: 播放第一步消息
    TH-->>IH: return True
    IH-->>CH: 跳过LLM处理
    
    Note over U,TTS: 阶段4: 处理用户回复
    U->>WS: 说话（音频）
    WS->>CH: 接收音频
    CH->>CH: ASR识别
    CH->>IH: handle_user_intent
    IH->>CSM: handle_user_input
    
    CSM->>R: 获取会话数据
    R-->>CSM: 会话数据
    CSM->>CSM: _process_teaching_response
    CSM->>DS: 获取当前步骤
    DS->>API: 获取步骤详情
    API-->>DS: 步骤配置
    DS-->>CSM: 步骤配置
    CSM->>CSM: _evaluate_response_with_config
    Note over CSM: 评估用户回复<br/>完全匹配/部分匹配/完全不匹配
    CSM->>CSM: 决定下一步动作
    CSM->>R: 更新会话数据
    
    alt 完全匹配
        CSM-->>IH: perfect_match_next
    else 部分匹配
        CSM-->>IH: partial_match_next
    else 完全不匹配
        CSM-->>IH: no_match_next
    end
    
    IH->>TH: handle_chat_mode
    TH->>DS: 获取步骤消息列表
    DS->>API: 获取消息列表
    API-->>DS: 消息列表
    DS-->>TH: 消息列表
    
    alt 有消息列表
        TH->>TTS: 发送消息列表
    else 无消息列表
        TH->>TTS: 发送评估反馈
    end
    
    TH->>CH: 设置llm_finish_task=True
    TTS->>U: 播放AI回复
    TH-->>IH: return True
    IH-->>CH: 跳过LLM处理
    
    Note over U,TTS: 阶段5: 教学完成
    CSM->>CSM: 检查是否完成所有步骤
    CSM->>CSM: 计算最终得分
    CSM->>API: 保存学习记录
    CSM->>R: 切换到自由模式
    CSM->>R: 删除会话数据
    CSM-->>IH: completed
    IH->>TH: handle_chat_mode
    TH->>TTS: 发送完成消息
    TH->>TTS: 发送自由聊天欢迎
    TTS->>U: 播放完成消息
    TH-->>IH: return None
    IH-->>CH: 继续LLM处理
```

## 🎯 核心类结构图

```mermaid
classDiagram
    class ConnectionHandler {
        +websocket: WebSocket
        +device_id: str
        +session_id: str
        +child_name: str
        +teaching_handler: TeachingHandler
        +handle_connection()
        +chat()
        +_handle_chat_mode()
        +_send_welcome_voice()
    }
    
    class TeachingHandler {
        +connection: ConnectionHandler
        +chat_status_manager: ChatStatusManager
        +child_name: str
        +handle_chat_mode()
        +_send_tts_message()
        +_send_message_list()
        +_end_tts_session()
        +_calculate_speech_duration()
    }
    
    class ChatStatusManager {
        +redis_client: RedisClient
        +dialogue_service: DialogueService
        +handle_user_input()
        +_handle_teaching_mode()
        +_start_teaching_session()
        +_process_teaching_response()
        +_evaluate_response_with_config()
        +_is_leaf_step()
    }
    
    class DialogueService {
        +config: Dict
        +api_base_url: str
        +start_scenario()
        +_get_scenario_steps()
        +_get_step_message_list()
    }
    
    class ScenarioManager {
        +get_active_scenarios()
        +get_scenario()
        +create_scenario()
        +update_scenario()
        +delete_scenario()
    }
    
    class LearningRecordManager {
        +save_learning_record()
        +get_learning_records()
    }
    
    ConnectionHandler --> TeachingHandler
    TeachingHandler --> ChatStatusManager
    ChatStatusManager --> DialogueService
    ChatStatusManager --> RedisClient
    DialogueService --> API
    ScenarioManager --> API
    LearningRecordManager --> API
```

## 📊 数据流架构图

```mermaid
flowchart TD
    subgraph "输入层"
        A1[用户音频]
        A2[WebSocket消息]
    end
    
    subgraph "处理层"
        B1[VAD检测]
        B2[ASR识别]
        B3[意图识别]
        B4[场景触发检测]
    end
    
    subgraph "业务层"
        C1[聊天状态管理]
        C2[回复评估]
        C3[步骤跳转]
        C4[消息生成]
    end
    
    subgraph "输出层"
        D1[TTS合成]
        D2[音频播放]
        D3[WebSocket发送]
    end
    
    subgraph "存储层"
        E1[Redis会话数据]
        E2[Redis聊天状态]
        E3[API场景配置]
        E4[数据库用户信息]
    end
    
    A1 --> B1
    A2 --> B2
    B1 --> B2
    B2 --> B3
    B3 --> B4
    B4 --> C1
    C1 --> C2
    C2 --> C3
    C3 --> C4
    C4 --> D1
    D1 --> D2
    D2 --> D3
    
    C1 --> E1
    C1 --> E2
    C1 --> E3
    C1 --> E4
    
    style C1 fill:#e1f5ff
    style C2 fill:#fff4e1
    style C3 fill:#e1ffe1
    style C4 fill:#f0e1ff
```

## 🔀 状态转换详细图

```mermaid
stateDiagram-v2
    [*] --> FreeMode: 连接建立
    
    FreeMode --> FreeMode: 自由聊天
    
    FreeMode --> TeachingMode: 场景触发
    
    TeachingMode --> StartSession: 首次触发
    StartSession --> GetSteps: 获取场景步骤
    GetSteps --> CreateSession: 创建会话数据
    CreateSession --> SendFirstMessage: 发送第一步
    SendFirstMessage --> WaitingResponse: 等待回复
    
    WaitingResponse --> ReceiveInput: 用户输入
    ReceiveInput --> Evaluating: 开始评估
    Evaluating --> GetCurrentStep: 获取当前步骤
    GetCurrentStep --> EvaluateResponse: 评估回复
    
    EvaluateResponse --> PerfectMatch: score >= 90
    EvaluateResponse --> PartialMatch: 60 <= score < 90
    EvaluateResponse --> NoMatch: score < 60
    EvaluateResponse --> LeafRetry: 叶子节点
    
    PerfectMatch --> FindNextStep: 查找下一步
    PartialMatch --> FindNextStep: 查找下一步
    NoMatch --> FindNextStep: 查找下一步
    
    FindNextStep --> UpdateSession: 更新会话
    UpdateSession --> SendNextMessage: 发送下一步
    SendNextMessage --> WaitingResponse: 等待回复
    
    LeafRetry --> CheckRetryCount: 检查重试次数
    CheckRetryCount --> RetryStep: 未达上限
    CheckRetryCount --> Completed: 达到上限
    RetryStep --> SendRetryMessage: 重复当前步骤
    SendRetryMessage --> WaitingResponse: 等待回复
    
    FindNextStep --> CheckAllSteps: 检查所有步骤
    CheckAllSteps --> Completed: 所有步骤完成
    CheckAllSteps --> WaitingResponse: 还有步骤
    
    Completed --> CalculateScore: 计算得分
    CalculateScore --> SaveRecord: 保存记录
    SaveRecord --> SwitchMode: 切换模式
    SwitchMode --> FreeMode: 自由模式
    
    TeachingMode --> FreeMode: 手动切换
```

## 🎨 功能模块职责划分

### 连接层 (ConnectionHandler)
- ✅ WebSocket连接管理
- ✅ 音频流处理
- ✅ 组件初始化
- ✅ 用户认证
- ✅ 对话历史管理

### 教学处理层 (TeachingHandler)
- ✅ 聊天模式切换处理
- ✅ TTS消息发送
- ✅ 消息列表管理
- ✅ TTS会话管理

### 状态管理层 (ChatStatusManager)
- ✅ 聊天状态管理
- ✅ 用户输入处理
- ✅ 回复评估
- ✅ 步骤跳转逻辑
- ✅ 会话数据管理

### 服务层 (DialogueService / ScenarioManager)
- ✅ API交互
- ✅ 场景配置获取
- ✅ 步骤配置获取
- ✅ 消息列表获取

### 数据层 (Redis / API / Database)
- ✅ 会话数据存储
- ✅ 聊天状态存储
- ✅ 场景配置存储
- ✅ 学习记录存储
- ✅ 用户信息存储

